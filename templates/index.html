<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KODV 가뭄 취약성 지도</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    
    <style>
        body { margin: 0; padding: 0; overflow: hidden; font-family: 'Pretendard', sans-serif; }
        #map { height: 100vh; width: 100%; z-index: 1; background: #eaebef; }
        
        .search-container { position: absolute; top: 30px; left: 50%; transform: translateX(-50%); z-index: 1000; width: 90%; max-width: 650px; display: flex; gap: 10px; }
        .search-box { flex-grow: 1; }
        
        #ai-result-panel {
            position: absolute; top: 100px; right: 20px; z-index: 1000;
            width: 380px; max-height: 80vh; overflow-y: auto;
            background: rgba(255, 255, 255, 0.95); border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            display: none; padding: 20px; backdrop-filter: blur(5px);
        }

        #loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 2000; display: none; background: rgba(255, 255, 255, 0.95); border-radius: 15px; box-shadow: 0 0 20px rgba(0,0,0,0.2); }
        #zoom-badge { position: absolute; bottom: 30px; right: 30px; z-index: 1000; background: rgba(33, 37, 41, 0.85); color: white; padding: 8px 16px; border-radius: 30px; font-size: 0.9rem; backdrop-filter: blur(4px); }
        .leaflet-interactive { outline: none; }
        pre { background: #f8f9fa; padding: 15px; border-radius: 5px; border: 1px solid #dee2e6; white-space: pre-wrap; word-break: break-all; }
        
        .table-custom th { background-color: #f1f3f5; }
        .table-custom td { vertical-align: middle; }
        
        /* 콘솔 스타일 */
        .console-textarea { background-color: #1e1e1e; color: #d4d4d4; font-family: 'Consolas', monospace; border: none; resize: vertical; }
        .console-textarea:focus { background-color: #1e1e1e; color: #fff; box-shadow: none; border: 1px solid #007bff; }

        /* 전문가 콘솔 탭 스타일링 */
        #consoleTab .nav-link {
            color: #6c757d; /* 기본: 회색 */
            font-weight: 600;
        }
        #consoleTab .nav-link.active {
            color: #0d6efd !important; /* 활성: 파란색 */
            background-color: #fff;
            border-color: #dee2e6 #dee2e6 #fff;
        }
        #consoleTab .nav-link:hover {
            color: #0a58ca;
        }
    </style>
</head>
<body>

    <div id="loading" class="p-4 text-center">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
        <div class="mt-3 fw-bold text-dark fs-5">데이터 로딩 중...</div>
    </div>

    <div id="zoom-badge"><i class="fa-solid fa-layer-group me-2"></i><span id="level-name">광역 (시도)</span></div>

    <div class="search-container">
        <div class="input-group shadow-lg rounded-pill overflow-hidden search-box">
            <span class="input-group-text bg-white border-0 ps-4"><i class="fa-solid fa-robot text-primary"></i></span>
            <input type="text" class="form-control border-0 p-3" placeholder="예: 전북에서 생활용수 이용량이 가장 많은 곳은?" id="searchInput" onkeypress="handleEnter(event)">
            <button class="btn btn-primary px-4 fw-bold" onclick="askAI()">검색</button>
        </div>
        
        <button class="btn btn-light shadow-lg rounded-circle" style="width: 58px; height: 58px;" onclick="showHelpModal()" title="사용 가능한 데이터 목록">
            <i class="fa-solid fa-circle-question fa-xl text-secondary"></i>
        </button>
        
        <button class="btn btn-dark shadow-lg rounded-circle" style="width: 58px; height: 58px;" onclick="showConsoleModal()" title="전문가용 SPARQL 콘솔">
            <i class="fa-solid fa-terminal fa-xl text-white"></i>
        </button>
    </div>

    <div id="ai-result-panel">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="fw-bold m-0"><i class="fa-solid fa-sparkles text-warning me-2"></i>AI 검색 결과</h5>
            <button class="btn btn-sm btn-light rounded-circle" onclick="$('#ai-result-panel').hide()"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div id="ai-content"></div>
    </div>

    <div class="modal fade" id="sparqlModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title"><i class="fa-solid fa-code me-2"></i>생성된 SPARQL 쿼리</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body"><pre><code id="sparql-code" class="text-primary fw-bold"></code></pre></div>
            </div>
        </div>
    </div>

<div class="modal fade" id="consoleModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title d-flex align-items-center">
                        <i class="fa-solid fa-terminal me-2 text-success"></i>SPARQL Expert Console
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body bg-light p-0">
                    <ul class="nav nav-tabs nav-fill bg-white border-bottom" id="consoleTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="query-tab" data-bs-toggle="tab" data-bs-target="#query-panel" type="button" role="tab">
                                <i class="fa-solid fa-code me-2"></i>Query Editor
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="vocab-tab" data-bs-toggle="tab" data-bs-target="#vocab-panel" type="button" role="tab">
                                <i class="fa-solid fa-book me-2"></i>Vocabulary Dictionary
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="ttl-tab" data-bs-toggle="tab" data-bs-target="#ttl-panel" type="button" role="tab">
                                <i class="fa-solid fa-file-code me-2"></i>Full Knowledge Graph (TTL)
                            </button>
                        </li>
                    </ul>

                    <div class="tab-content p-3" id="consoleTabContent">
                        
                        <div class="tab-pane fade show active" id="query-panel" role="tabpanel">
                            
                            <div class="alert alert-secondary py-2 px-3 mb-2 small">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span>
                                        <i class="fa-solid fa-circle-check text-success me-2"></i><strong>Prefix 자동 적용됨:</strong> kodv, koad, rdfs, skos, etc.
                                    </span>
                                    <button class="btn btn-sm btn-outline-dark" type="button" data-bs-toggle="collapse" data-bs-target="#prefixCollapse" aria-expanded="false">
                                        <i class="fa-solid fa-list me-1"></i>Prefix 목록 보기
                                    </button>
                                </div>
                                
                                <div class="collapse mt-2" id="prefixCollapse">
                                    <div class="card card-body bg-white border p-0 overflow-hidden">
                                        <table class="table table-sm table-striped mb-0 table-bordered" style="font-size: 0.85rem;">
                                            <thead class="table-light">
                                                <tr>
                                                    <th style="width: 15%" class="text-center">Prefix</th>
                                                    <th>Namespace URI</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr><td class="text-center fw-bold">kodv</td><td class="font-monospace text-muted">&lt;https://knowledgemap.kr/kodv/def/&gt;</td></tr>
                                                <tr><td class="text-center fw-bold">kodvid</td><td class="font-monospace text-muted">&lt;https://knowledgemap.kr/kodv/id/&gt;</td></tr>
                                                <tr><td class="text-center fw-bold">koad</td><td class="font-monospace text-muted">&lt;http://vocab.datahub.kr/def/administrative-division/&gt;</td></tr>
                                                <tr><td class="text-center fw-bold">rdfs</td><td class="font-monospace text-muted">&lt;http://www.w3.org/2000/01/rdf-schema#&gt;</td></tr>
                                                <tr><td class="text-center fw-bold">skos</td><td class="font-monospace text-muted">&lt;http://www.w3.org/2004/02/skos/core#&gt;</td></tr>
                                                <tr><td class="text-center fw-bold">qudt</td><td class="font-monospace text-muted">&lt;http://qudt.org/schema/qudt/&gt;</td></tr>
                                                <tr><td class="text-center fw-bold">unit</td><td class="font-monospace text-muted">&lt;http://qudt.org/vocab/unit/&gt;</td></tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <div class="d-flex justify-content-end mb-1">
                                    <span class="badge bg-danger me-1"><i class="fa-solid fa-ban me-1"></i>DELETE/UPDATE 금지</span>
                                    <span class="badge bg-success"><i class="fa-solid fa-check me-1"></i>SELECT 허용</span>
                                </div>
                                
                                <textarea id="console-input" class="form-control console-textarea p-3 font-monospace" rows="10" spellcheck="false" 
                                style="background-color: #1e1e1e; color: #d4d4d4; border: 1px solid #333; font-size: 0.95rem;">
SELECT ?name ?pop
WHERE {
  ?s a koad:Dong ;
     rdfs:label ?name ;
     kodv:population ?pop .
}
ORDER BY DESC(?pop)
LIMIT 5</textarea>
                            </div>

                            <button class="btn btn-primary w-100 fw-bold py-2 shadow-sm" onclick="runConsoleQuery()">
                                <i class="fa-solid fa-play me-2"></i> 쿼리 실행 (Execute)
                            </button>
                            
                            <hr class="my-4">
                            
                            <label class="form-label fw-bold"><i class="fa-solid fa-table me-2"></i>실행 결과 (Result)</label>
                            <div class="table-responsive bg-white border rounded" style="max-height: 250px; min-height: 100px;">
                                <table class="table table-sm table-hover table-striped mb-0 small" id="console-result-table">
                                    <thead class="table-light sticky-top"><tr><th class="p-3 text-center text-muted">결과가 여기에 표시됩니다.</th></tr></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="vocab-panel" role="tabpanel">
                            <div class="alert alert-info py-2 small mb-2">
                                <i class="fa-solid fa-info-circle me-2"></i>KODV 프로젝트에서 사용된 모든 어휘 및 매핑 정보입니다.
                            </div>
                            <div class="table-responsive border rounded bg-white shadow-sm" style="height: 600px; overflow-y: auto;">
                                <table class="table table-hover table-bordered mb-0 small">
                                    <thead class="table-light sticky-top">
                                        <tr class="text-center">
                                            <th style="width: 12%">유형</th>
                                            <th style="width: 30%">어휘 (Vocabulary)</th>
                                            <th style="width: 18%">항목명 (Label)</th>
                                            <th>설명 (Description)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr class="table-secondary"><td colspan="4" class="fw-bold ps-3">1. 행정구역 클래스 (koad)</td></tr>
                                        <tr><td><span class="badge bg-primary">Class</span></td><td class="font-monospace text-primary">koad:SpecialMetropolitanCity</td><td>특별시</td><td>서울</td></tr>
                                        <tr><td><span class="badge bg-primary">Class</span></td><td class="font-monospace text-primary">koad:MetropolitanCity</td><td>광역시</td><td>부산, 인천 등</td></tr>
                                        <tr><td><span class="badge bg-primary">Class</span></td><td class="font-monospace text-primary">koad:SpecialSelfGoverningCity</td><td>특별자치시</td><td>세종</td></tr>
                                        <tr><td><span class="badge bg-primary">Class</span></td><td class="font-monospace text-primary">koad:Province</td><td>도</td><td>경기, 강원 등</td></tr>
                                        <tr><td><span class="badge bg-primary">Class</span></td><td class="font-monospace text-primary">koad:SpecialSelfGoverningProvince</td><td>특별자치도</td><td>제주, 강원</td></tr>
                                        <tr><td><span class="badge bg-primary">Class</span></td><td class="font-monospace text-primary">koad:City</td><td>시</td><td>일반 시</td></tr>
                                        <tr><td><span class="badge bg-primary">Class</span></td><td class="font-monospace text-primary">koad:County</td><td>군</td><td>군 지역</td></tr>
                                        <tr><td><span class="badge bg-primary">Class</span></td><td class="font-monospace text-primary">koad:District</td><td>구 (자치구)</td><td>특별시/광역시 산하</td></tr>
                                        <tr><td><span class="badge bg-primary">Class</span></td><td class="font-monospace text-primary">koad:AdministrativeCity</td><td>행정시</td><td>제주시, 서귀포시 등</td></tr>
                                        <tr><td><span class="badge bg-primary">Class</span></td><td class="font-monospace text-primary">koad:NonAutonomousDistrict</td><td>구 (행정구)</td><td>수원 팔달구 등</td></tr>
                                        <tr><td><span class="badge bg-primary">Class</span></td><td class="font-monospace text-primary">koad:Eup</td><td>읍</td><td>L3 행정구역</td></tr>
                                        <tr><td><span class="badge bg-primary">Class</span></td><td class="font-monospace text-primary">koad:Myeon</td><td>면</td><td>L3 행정구역</td></tr>
                                        <tr><td><span class="badge bg-primary">Class</span></td><td class="font-monospace text-primary">koad:Dong</td><td>동 (행정동)</td><td>L3 행정구역</td></tr>

                                        <tr class="table-secondary"><td colspan="4" class="fw-bold ps-3">2. 행정구역 관계 (koad)</td></tr>
                                        <tr><td><span class="badge bg-success">Down</span></td><td class="font-monospace text-success">koad:includesCity</td><td>시 포함</td><td>도 -> 시</td></tr>
                                        <tr><td><span class="badge bg-success">Down</span></td><td class="font-monospace text-success">koad:includesCounty</td><td>군 포함</td><td>도 -> 군</td></tr>
                                        <tr><td><span class="badge bg-success">Down</span></td><td class="font-monospace text-success">koad:includesDistrict</td><td>구 포함</td><td>시 -> 구</td></tr>
                                        <tr><td><span class="badge bg-success">Down</span></td><td class="font-monospace text-success">koad:includesTown</td><td>읍 포함</td><td>시군 -> 읍</td></tr>
                                        <tr><td><span class="badge bg-success">Down</span></td><td class="font-monospace text-success">koad:includesTownship</td><td>면 포함</td><td>시군 -> 면</td></tr>
                                        <tr><td><span class="badge bg-success">Down</span></td><td class="font-monospace text-success">koad:includesNeighborhood</td><td>동 포함</td><td>시군구 -> 동</td></tr>
                                        <tr><td><span class="badge bg-warning text-dark">Up</span></td><td class="font-monospace text-dark">koad:isCityOf</td><td>~에 속한 시</td><td>시 -> 도 (역관계)</td></tr>
                                        <tr><td><span class="badge bg-warning text-dark">Up</span></td><td class="font-monospace text-dark">koad:isCountyOf</td><td>~에 속한 군</td><td>군 -> 도 (역관계)</td></tr>
                                        <tr><td><span class="badge bg-warning text-dark">Up</span></td><td class="font-monospace text-dark">koad:isDistrictOf</td><td>~에 속한 구</td><td>구 -> 시 (역관계)</td></tr>
                                        <tr><td><span class="badge bg-warning text-dark">Up</span></td><td class="font-monospace text-dark">koad:isTownOf</td><td>~에 속한 읍</td><td>읍 -> 시군 (역관계)</td></tr>
                                        <tr><td><span class="badge bg-warning text-dark">Up</span></td><td class="font-monospace text-dark">koad:isTownshipOf</td><td>~에 속한 면</td><td>면 -> 시군 (역관계)</td></tr>
                                        <tr><td><span class="badge bg-warning text-dark">Up</span></td><td class="font-monospace text-dark">koad:isNeighborhoodOf</td><td>~에 속한 동</td><td>동 -> 시군구 (역관계)</td></tr>
                                        <tr><td><span class="badge bg-info text-dark">Prop</span></td><td class="font-monospace text-dark">koad:divisionCode</td><td>행정구역코드</td><td>Unique ID (String)</td></tr>

                                        <tr class="table-secondary"><td colspan="4" class="fw-bold ps-3">3. 가뭄 데이터 속성 (kodv - L3 전용)</td></tr>
                                        <tr><td><span class="badge bg-info text-dark">Prop</span></td><td class="font-monospace text-dark">kodv:population</td><td>인구</td><td>거주 총 인구수</td></tr>
                                        <tr><td><span class="badge bg-info text-dark">Prop</span></td><td class="font-monospace text-dark">kodv:waterSupplyRate</td><td>급수율</td><td>상수도 보급률(%)</td></tr>
                                        <tr><td><span class="badge bg-info text-dark">Prop</span></td><td class="font-monospace text-dark">kodv:waterSupplyPopulation</td><td>급수인구</td><td>상수도 공급 인구</td></tr>
                                        <tr><td><span class="badge bg-info text-dark">Prop</span></td><td class="font-monospace text-dark">kodv:droughtSeverityAvg</td><td>평균 가뭄 심도</td><td>가뭄 심각도 (SPI)</td></tr>
                                        <tr><td><span class="badge bg-info text-dark">Prop</span></td><td class="font-monospace text-dark">kodv:droughtFrequency</td><td>가뭄 발생 빈도</td><td>발생 횟수 (Count)</td></tr>
                                        <tr><td><span class="badge bg-info text-dark">Prop</span></td><td class="font-monospace text-dark">kodv:droughtExposureScore</td><td>가뭄 노출도</td><td>종합 점수</td></tr>
                                        <tr><td><span class="badge bg-info text-dark">Prop</span></td><td class="font-monospace text-dark">kodv:exposureCoefficient</td><td>노출도 계수</td><td>표준화 계수</td></tr>
                                        <tr><td><span class="badge bg-info text-dark">Prop</span></td><td class="font-monospace text-dark">kodv:domesticWaterUsage</td><td>생활용수 이용량</td><td>가정용 사용량</td></tr>
                                        <tr><td><span class="badge bg-info text-dark">Prop</span></td><td class="font-monospace text-dark">kodv:industrialWaterUsage</td><td>공업용수 이용량</td><td>산업용 사용량</td></tr>
                                        <tr><td><span class="badge bg-info text-dark">Prop</span></td><td class="font-monospace text-dark">kodv:sensitivityCoefficient</td><td>민감도 계수</td><td>표준화 계수</td></tr>
                                        <tr><td><span class="badge bg-info text-dark">Prop</span></td><td class="font-monospace text-dark">kodv:reservoirCapacity</td><td>저수지 유효 저수량</td><td>천㎥ 단위</td></tr>
                                        <tr><td><span class="badge bg-info text-dark">Prop</span></td><td class="font-monospace text-dark">kodv:groundwaterAvailable</td><td>지하수 개발가능량</td><td>천㎥ 단위</td></tr>
                                        <tr><td><span class="badge bg-info text-dark">Prop</span></td><td class="font-monospace text-dark">kodv:livingIndustrialWaterUsage</td><td>생·공용수 이용량</td><td>생활+공업 합산</td></tr>
                                        <tr><td><span class="badge bg-info text-dark">Prop</span></td><td class="font-monospace text-dark">kodv:auxWaterSourceCapacity</td><td>보조수원능력</td><td>종합 능력</td></tr>
                                        <tr><td><span class="badge bg-info text-dark">Prop</span></td><td class="font-monospace text-dark">kodv:auxWaterSourceCoefficient</td><td>보조수원계수</td><td>표준화 계수</td></tr>
                                        <tr><td><span class="badge bg-info text-dark">Prop</span></td><td class="font-monospace text-dark">kodv:waterSupplyAvailableDays</td><td>용수공급 가능일수</td><td>지속 가능 일수</td></tr>
                                        <tr><td><span class="badge bg-info text-dark">Prop</span></td><td class="font-monospace text-dark">kodv:responseCapacityCoefficient</td><td>대응능력계수</td><td>표준화 계수</td></tr>
                                        <tr><td><span class="badge bg-info text-dark">Prop</span></td><td class="font-monospace text-dark">kodv:vulnerabilityScore</td><td>취약성 점수</td><td>최종 취약성 점수</td></tr>
                                        <tr><td><span class="badge bg-info text-dark">Prop</span></td><td class="font-monospace text-dark">kodv:vulnerabilityRatingNumeric</td><td>취약성 등급 (숫자)</td><td>1~5 (비교/정렬용)</td></tr>

                                        <tr class="table-secondary"><td colspan="4" class="fw-bold ps-3">4. 등급 식별자 (kodvid)</td></tr>
                                        <tr><td><span class="badge bg-warning text-dark">Instance</span></td><td class="font-monospace">kodvid:Rating_I</td><td>I 등급 (관심)</td><td>URI Resource</td></tr>
                                        <tr><td><span class="badge bg-warning text-dark">Instance</span></td><td class="font-monospace">kodvid:Rating_II</td><td>II 등급 (주의)</td><td>URI Resource</td></tr>
                                        <tr><td><span class="badge bg-warning text-dark">Instance</span></td><td class="font-monospace">kodvid:Rating_III</td><td>III 등급 (경계)</td><td>URI Resource</td></tr>
                                        <tr><td><span class="badge bg-warning text-dark">Instance</span></td><td class="font-monospace">kodvid:Rating_IV</td><td>IV 등급 (심각)</td><td>URI Resource</td></tr>
                                        <tr><td><span class="badge bg-warning text-dark">Instance</span></td><td class="font-monospace">kodvid:Rating_V</td><td>V 등급 (매우심각)</td><td>URI Resource</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="ttl-panel" role="tabpanel">
                            <div class="alert alert-secondary py-2 small mb-2 d-flex justify-content-between align-items-center">
                                <span><i class="fa-solid fa-file-lines me-2"></i>"KODV의 전체 지식그래프(Schema + Instance) 소스 코드입니다. (총 88,917 Triples)"</span>
                                <span id="ttl-loading" class="text-primary fw-bold" style="display:none;">
                                    <i class="fa-solid fa-spinner fa-spin me-1"></i>Loading...
                                </span>
                            </div>
                            
                            <div class="position-relative">
                                <pre id="ttl-content" class="bg-dark text-light p-3 rounded border border-secondary shadow-sm" 
                                     style="height: 600px; overflow-y: auto; font-size: 0.85rem; line-height: 1.5;">
(파일을 불러오려면 'Ontology Example' 탭을 클릭하세요...)
                                </pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="map"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>
        // 1. 지도 생성 (대한민국 중심, 축소만 제한하고 이동은 자유롭게)
        var map = L.map('map', {
            // maxBounds 삭제: 이제 지도를 마음껏 끌어서 움직일 수 있습니다.
            minZoom: 7, // 너무 작게 축소해서 지구가 다 보이는 건 방지
            maxZoom: 18 // 최대 확대 제한
        }).setView([36.5, 127.5], 7);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { 
            attribution: '&copy; CARTO', 
            maxZoom: 19 
        }).addTo(map);

        var sidoLayer, sigLayer, emdLayer, dbCodes = [], highlightLayer;
        var lastSparql = "";

        function showLoading(show, text="로딩 중...") { 
            $('#loading .mt-3').text(text);
            $('#loading').css('display', show ? 'block' : 'none'); 
        }

        function fixName(name) {
            if (name === "강원도") return "강원특별자치도";
            if (name === "전라북도") return "전북특별자치도";
            return name;
        }

        function getProps(feature) {
            var p = feature.properties;
            var code = String(p.CTPRVN_CD || p.CTP_RVN_CD || p.SIG_CD || p.sig_cd || p.adm_cd2 || p.adm_cd || "");
            var name = p.CTP_KOR_NM || p.ctp_kor_nm || p.SIG_KOR_NM || p.sig_kor_nm || p.adm_nm || p.name || "이름없음";
            return { code: code, name: fixName(name) };
        }

        showLoading(true);
        $.getJSON("/api/existing-codes", function(codes) {
            dbCodes = codes;
            $.getJSON("{{ url_for('static', filename='sido.json') }}", function(data) {
                sidoLayer = L.geoJson(data, { style: styleSido, onEachFeature: onEachRegion });
                sidoLayer.addTo(map);
                $.getJSON("{{ url_for('static', filename='sig.json') }}", function(data) {
                    sigLayer = L.geoJson(data, { style: styleSig, onEachFeature: onEachRegion });
                    $.getJSON("{{ url_for('static', filename='emd.geojson') }}", function(data) {
                        emdLayer = L.geoJson(data, { style: styleEmd, onEachFeature: onEachRegion });
                        showLoading(false);
                        updateLayer();
                    });
                });
            });
        });

        function styleSido(f) { return { color: "#2c3e50", weight: 2, opacity: 0.8, fillColor: "transparent", fillOpacity: 0 }; }
        function styleSig(f) { return { color: "#5e72e4", weight: 1.5, opacity: 0.6, fillColor: "#5e72e4", fillOpacity: 0.05 }; }
        function styleEmd(f) { return { color: "#fb6340", weight: 1, opacity: 0.8, fillColor: "#fb6340", fillOpacity: 0.1 }; }

        function onEachRegion(feature, layer) {
            var props = getProps(feature);
            var code = props.code;
            var name = props.name;

            layer.bindTooltip(`<b>${name}</b>`, { direction: "top", sticky: true });
            layer.on('mouseover', function() { this.setStyle({ fillOpacity: 0.3, weight: 3 }); });
            layer.on('mouseout', function() { 
                var defStyle;
                if (code.length === 2) defStyle = styleSido;
                else if (code.length === 5) defStyle = styleSig;
                else defStyle = styleEmd;
                this.setStyle(defStyle()); 
            });

            layer.on('click', function(e) {
                if (!code) return;
                showLoading(true, "상세 정보 조회 중...");
                map.panTo(e.latlng, { animate: true, duration: 0.8 });

                $.getJSON("/api/data/" + code, function(res) {
                    showLoading(false);
                    var content = "";
                    var level = (code.length === 2) ? 'L1' : (code.length === 5) ? 'L2' : 'L3';
                    
                    var zoomBtn = "";
                    if (level !== 'L3') {
                        zoomBtn = `<button class="btn btn-sm btn-outline-primary w-100 mt-2" onclick="zoomToRegion(${e.latlng.lat}, ${e.latlng.lng}, '${level}')"><i class="fa-solid fa-magnifying-glass-plus"></i> 상세 지역 보기</button>`;
                    }

                    if (res.status === "success") {
                        var d = res.data;
                        var finalName = (d.label && d.label.value) ? d.label.value : name;
                        var noImage = "https://upload.wikimedia.org/wikipedia/commons/thumb/a/ac/No_image_available.svg/300px-No_image_available.svg.png";
                        var imgUrl = (d.image && d.image.value) ? d.image.value : noImage;
                        var desc = (d.desc && d.desc.value) ? d.desc.value : "위키데이터 설명이 없습니다.";
                        var grade = d.gradeLabel ? `<span class="badge bg-danger ms-1">${d.gradeLabel.value}</span>` : "";
                        var score = d.vulScore ? `${parseFloat(d.vulScore.value).toFixed(2)}점` : "";
                        
                        content = `
                            <div class="card border-0 shadow-sm" style="width: 280px; overflow: hidden;">
                                <div style="height: 160px; overflow: hidden; background: #eee;">
                                    <img src="${imgUrl}" class="w-100 h-100" style="object-fit: contain; padding:5px; background:white;" alt="${finalName}">
                                </div>
                                <div class="card-body p-3">
                                    <h5 class="card-title fw-bold mb-1">${finalName} ${grade}</h5>
                                    <p class="text-muted small mb-2 text-truncate">${desc}</p>
                                    ${score ? `<div class="d-flex justify-content-between mb-1 small"><span><i class="fa-solid fa-chart-line text-warning"></i> 점수</span><strong>${score}</strong></div>` : ""}
                                    <div class="d-grid mt-2">
                                        <a href="${d.wikiURI ? d.wikiURI.value : '#'}" target="_blank" class="btn btn-sm btn-dark"><i class="fa-brands fa-wikipedia-w"></i> 위키데이터</a>
                                    </div>
                                    ${zoomBtn}
                                </div>
                                <div class="card-footer bg-light text-muted text-center py-1" style="font-size: 0.7rem;">
                                    ※ Wikidata 이미지/로고 무작위 노출
                                </div>
                            </div>
                        `;
                    } else {
                        content = `
                            <div class="p-3 text-center">
                                <h6 class="fw-bold">${name}</h6>
                                <p class="text-muted small mb-2">가뭄 데이터 없음</p>
                                ${zoomBtn}
                            </div>
                        `;
                    }
                    layer.bindPopup(content).openPopup();
                });
            });
        }

        function handleEnter(e) { if(e.key === 'Enter') askAI(); }
        function askAI() {
            var q = $('#searchInput').val(); if(!q) return alert("질문을 입력하세요!");
            showLoading(true, "AI가 분석 중...");
            $('#ai-result-panel').hide();
            if(highlightLayer) map.removeLayer(highlightLayer);
            $.ajax({
                url: '/api/ask', type: 'POST', contentType: 'application/json', data: JSON.stringify({ question: q }),
                success: function(res) {
                    showLoading(false);
                    if(res.status==='success') { lastSparql=res.sparql; displayAIResults(res.data); }
                    else alert("AI 오류: "+res.message);
                },
                error: function(){ showLoading(false); alert("서버 오류"); }
            });
        }
        function displayAIResults(data) {
            var html = '<div class="list-group">'; var codes=[];
            data.forEach(function(i){
                var nm=i.name?i.name.value:"-"; var cd=i.code?i.code.value:""; var v=i.val?i.val.value:"";
                if(v&&!isNaN(v)) v=Number(v).toLocaleString();
                if(cd) codes.push(cd);
                html+=`<div class="list-group-item d-flex justify-content-between"><div>${nm}<br><small>${cd}</small></div><span class="badge bg-primary rounded-pill h-50">${v}</span></div>`;
            });
            html+=`</div><div class="mt-2"><button class="btn btn-sm btn-secondary w-100" onclick="showSparqlModal()">SPARQL 보기</button></div>`;
            $('#ai-content').html(html); $('#ai-result-panel').show();
            // 하이라이트 로직
            if(emdLayer && codes.length > 0) {
                $.getJSON("{{ url_for('static', filename='emd.geojson') }}", function(geoData) {
                    var filtered = { type:"FeatureCollection", features:[] };
                    filtered.features = geoData.features.filter(f => {
                        var c = String(f.properties.adm_cd2 || f.properties.adm_cd || "");
                        return codes.includes(c);
                    });
                    if(filtered.features.length > 0) {
                        highlightLayer = L.geoJson(filtered, { style: { color: "red", weight: 3, fillColor: "red", fillOpacity: 0.6 } }).addTo(map);
                        map.fitBounds(highlightLayer.getBounds());
                    }
                });
            }
        }

        function showSparqlModal() { if(!lastSparql) return; $('#sparql-code').text(lastSparql); new bootstrap.Modal(document.getElementById('sparqlModal')).show(); }
        function showHelpModal() { new bootstrap.Modal(document.getElementById('helpModal')).show(); }
        
        // ★ [신규] 전문가 콘솔 모달
        function showConsoleModal() { new bootstrap.Modal(document.getElementById('consoleModal')).show(); }

        // ★ [신규] 전문가 콘솔 실행
        function runConsoleQuery() {
            var q = $('#console-input').val(); if(!q) return alert("쿼리 입력");
            var btn = $('#consoleModal button i'); btn.attr('class', 'fa-solid fa-spinner fa-spin');
            $.ajax({
                url: '/api/sparql', type: 'POST', contentType: 'application/json', data: JSON.stringify({ query: q }),
                success: function(res) {
                    btn.attr('class', 'fa-solid fa-play');
                    if(res.status==='success') {
                        var h='<tr>'; res.vars.forEach(v=>{h+=`<th>${v}</th>`}); h+='</tr>'; $('#console-result-table thead').html(h);
                        var b=''; 
                        if(res.data.length===0) b=`<tr><td colspan="${res.vars.length}" class="text-center text-muted">결과가 없습니다.</td></tr>`;
                        else {
                            res.data.forEach(r=>{ b+='<tr>'; res.vars.forEach(v=>{ var val=r[v]?r[v].value:""; if(val.startsWith("http")) val=`<a href="${val}" target="_blank">URI</a>`; b+=`<td>${val}</td>`; }); b+='</tr>'; });
                        }
                        $('#console-result-table tbody').html(b);
                    } else alert("Error: "+res.message);
                },
                error: function(){ btn.attr('class', 'fa-solid fa-play'); alert("Conn Error"); }
            });
        }

        window.zoomToRegion = function(lat, lng, level) {
            var z = (level === 'L1') ? 9 : 11;
            map.setView([lat, lng], z, { animate: true, duration: 1.5 });
        };

        function updateLayer() {
            var z = map.getZoom();
            var b = document.getElementById('level-name');
            if(sidoLayer) map.removeLayer(sidoLayer); if(sigLayer) map.removeLayer(sigLayer); if(emdLayer) map.removeLayer(emdLayer); if(highlightLayer) map.addLayer(highlightLayer);
            if(z<9) { if(sidoLayer) map.addLayer(sidoLayer); b.innerText = "광역 (시도)"; }
            else if(z>=9 && z<11) { if(sigLayer) map.addLayer(sigLayer); b.innerText = "기초 (시군구)"; }
            else { if(emdLayer) map.addLayer(emdLayer); b.innerText = "상세 (읍면동)"; }
        }
        map.on('zoomend', updateLayer);

        // [최적화] 페이지 로드 시 TTL 파일 백그라운드 미리 읽기 (Pre-loading)
        document.addEventListener("DOMContentLoaded", function() {
            const ttlContentBox = document.getElementById('ttl-content');
            const loadingText = document.getElementById('ttl-loading');
    
            // 파일 경로 (static 폴더 내 실제 파일명으로 수정 필요)
            const filePath = '/static/KODV_KnowledgeGraph_Final.ttl';

            // 1. 로딩 표시 활성화 (혹시 사용자가 0.1초만에 탭을 누를 경우를 대비)
            if(loadingText) loadingText.style.display = 'inline-block';
            if(ttlContentBox) ttlContentBox.textContent = "Background loading in progress...";

            // 2. 백그라운드 Fetch
            fetch(filePath)
                .then(response => {
                    if (!response.ok) throw new Error("File not found (" + response.status + ")");
                    return response.text();
                })
                .then(text => {
                    // 3. 숨겨진 탭에 미리 텍스트 주입 (DOM 렌더링 비용 미리 지불)
                    if(ttlContentBox) ttlContentBox.textContent = text;
                })
                .catch(err => {
                    if(ttlContentBox) ttlContentBox.textContent = "Error loading TTL: " + err.message;
                })
                .finally(() => {
                    // 4. 로딩 표시 숨김
                    if(loadingText) loadingText.style.display = 'none';
                });
        });
    </script>
</body>
</html>