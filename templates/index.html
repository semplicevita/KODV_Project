<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KODV 가뭄 취약성 지도</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>💧</text></svg>">

    <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    
</head>
<body>

    <div id="loading" class="p-4 text-center">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
        <div class="mt-3 fw-bold text-dark fs-5">데이터 로딩 중...</div>
    </div>

    <div id="zoom-badge"><i class="fa-solid fa-layer-group me-2"></i><span id="level-name">광역 (시도)</span></div>

    <div class="search-container">
        <div class="left-group">
            <button class="btn btn-light shadow-lg rounded-circle" style="width: 58px; height: 58px;" onclick="showHelpModal()" title="사용 가능한 데이터 목록">
                <i class="fa-solid fa-circle-question fa-xl text-secondary"></i>
            </button>
        </div>

        <div class="input-group shadow-lg rounded-pill overflow-hidden search-box">
            <span class="input-group-text bg-white border-0 ps-4"><i class="fa-solid fa-robot text-primary"></i></span>
            <input type="text" class="form-control border-0 p-3" placeholder="예: 전북에서 생활용수 이용량이 가장 많은 곳은?" id="searchInput" onkeypress="handleEnter(event)">
            <button class="btn btn-primary px-4 fw-bold" onclick="askAI()">검색</button>
        </div>
        
        <div class="right-group">
            <button class="btn btn-success shadow-lg rounded-circle" style="width: 58px; height: 58px;" onclick="openEasyQuery()" title="데이터 탐색기 (초보자용)">
                <i class="fa-solid fa-magic fa-xl text-white"></i>
            </button>
            
            <button class="btn btn-dark shadow-lg rounded-circle" style="width: 58px; height: 58px;" onclick="showConsoleModal()" title="전문가용 SPARQL 콘솔">
                <i class="fa-solid fa-terminal fa-xl text-white"></i>
            </button>
        </div>
    </div>

    <div id="ai-result-panel">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="fw-bold m-0"><i class="fa-solid fa-sparkles text-warning me-2"></i>검색 결과</h5>
            <button class="btn btn-sm btn-light rounded-circle" onclick="$('#ai-result-panel').hide()"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div id="ai-content"></div>
    </div>

    <div class="modal fade" id="sparqlModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title"><i class="fa-solid fa-code me-2"></i>생성된 SPARQL 쿼리</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body"><pre><code id="sparql-code" class="text-primary fw-bold"></code></pre></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="helpModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-light">
                <h5 class="modal-title fw-bold"><i class="fa-solid fa-database text-primary me-2"></i>사용 가능한 가뭄 데이터 목록
                    (총 19종)</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">

                <div class="alert alert-primary m-3 border-0 small">
                    <h6 class="fw-bold mb-2"><i class="fa-solid fa-circle-info me-2"></i>AI 의미 검색 활용 가이드</h6>

                    <div class="mb-3">
                        <strong>✅ 기능: 두 가지 방식으로 질문할 수 있습니다.</strong>
                        <ul class="list-unstyled ps-2 mt-1 mb-0">
                            <li class="mb-2">
                                <span class="badge bg-primary bg-opacity-10 text-primary border border-primary me-1">지역
                                    검색 (Highlight)</span>
                                "충남에서 <strong>인구</strong>가 3만 명을 넘는 곳은?"<br>
                                "전국에서 <strong>급수율</strong>이 낮은 지역 하위<strong> 20곳</strong>을 알려줘"
                                <br><span class="text-muted ms-1" style="font-size: 0.9em;">→ 조건에 맞는 읍면동 지역을 지도에
                                    표시합니다.</span>
                            </li>
                            <li>
                                <span class="badge bg-success bg-opacity-10 text-success border border-success me-1">통계
                                    조회 (Value)</span>
                                "서울의 <strong>평균 취약성 등급</strong>은?"
                                <br><span class="text-muted ms-1" style="font-size: 0.9em;">→ AI가 최하위 지역 데이터를 집계(평균, 합계
                                    등)하여 값을 알려줍니다.</span>
                            </li>
                        </ul>
                    </div>

                    <div class="mb-0 pt-2 border-top border-primary border-opacity-25">
                        <strong>⚠️ 질문 작성 팁 (정확한 분석을 위해 필수!)</strong>
                        <ul class="mb-0 ps-3">
                            <li class="mb-1">
                                <strong>지역 범위와 개수 포함하기:</strong> 데이터 양이 많을 수 있으므로 <strong>"10 곳", "상위 30개"</strong> 처럼 개수를 제한하고 <strong>"~에서"</strong>라는
                                범위를 명시해 주세요.
                            </li>
                            <li>
                                <strong>정확한 명칭 사용:</strong> 아래 표의 <strong>'데이터 항목(굵은 글씨)'</strong> 이름을 포함해야 <strong>AI</strong>가 <strong>RAG(Retrieval-Augmented
                                    Generation)</strong>기반의 검색을 할 수 있습니다.
                            </li>
                        </ul>
                    </div>
                </div>

                <div class="table-responsive" style="max-height: 60vh;">
                    <table class="table table-hover table-bordered mb-0 small table-custom">
                        <thead class="table-light sticky-top">
                            <tr class="text-center">
                                <th style="width: 15%">분류</th>
                                <th style="width: 35%">데이터 항목 (키워드)</th>
                                <th>설명</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td rowspan="3" class="text-center bg-white fw-bold text-secondary">급수 인구 정보</td>
                                <td><strong>인구</strong></td>
                                <td>행정구역 내 거주 인구수</td>
                            </tr>
                            <tr>
                                <td><strong>급수율</strong></td>
                                <td>상수도 보급 비율 (%)</td>
                            </tr>
                            <tr>
                                <td><strong>급수인구</strong></td>
                                <td>실제 상수도를 공급받는 인구</td>
                            </tr>
                            <tr>
                                <td rowspan="4" class="text-center bg-white fw-bold text-secondary">노출도</td>
                                <td><strong>평균 가뭄 심도</strong></td>
                                <td>기상학적 가뭄의 평균 심각도</td>
                            </tr>
                            <tr>
                                <td><strong>가뭄 발생 빈도</strong></td>
                                <td>과거 가뭄 발생 횟수</td>
                            </tr>
                            <tr>
                                <td><strong>가뭄 노출도</strong></td>
                                <td>심도와 빈도를 종합한 점수</td>
                            </tr>
                            <tr>
                                <td><strong>노출도 계수</strong></td>
                                <td>노출도 점수의 표준화 계수</td>
                            </tr>
                            <tr>
                                <td rowspan="4" class="text-center bg-white fw-bold text-secondary">민감도</td>
                                <td><strong>생활용수 이용량</strong></td>
                                <td>가정 등 일상생활 물 사용량</td>
                            </tr>
                            <tr>
                                <td><strong>공업용수 이용량</strong></td>
                                <td>산업/공장용 물 사용량</td>
                            </tr>
                            <tr>
                                <td><strong>생·공용수 이용량</strong></td>
                                <td>생활용수 + 공업용수 합계</td>
                            </tr>
                            <tr>
                                <td><strong>민감도 계수</strong></td>
                                <td>수요 기반 피해 가능성 계수</td>
                            </tr>
                            <tr>
                                <td rowspan="4" class="text-center bg-white fw-bold text-secondary">보조수원</td>
                                <td><strong>저수지 유효 저수량</strong></td>
                                <td>사용 가능한 저수지 물의 양</td>
                            </tr>
                            <tr>
                                <td><strong>지하수 개발 가능량</strong></td>
                                <td>이용 가능한 지하수 총량</td>
                            </tr>
                            <tr>
                                <td><strong>보조수원 능력</strong></td>
                                <td>비상시 물 공급 잠재력</td>
                            </tr>
                            <tr>
                                <td><strong>보조수원 계수</strong></td>
                                <td>보조수원 능력의 표준화 계수</td>
                            </tr>
                            <tr>
                                <td rowspan="2" class="text-center bg-white fw-bold text-secondary">대응 능력</td>
                                <td><strong>용수공급 가능일수</strong></td>
                                <td>물 공급 지속 가능 예상 일수</td>
                            </tr>
                            <tr>
                                <td><strong>대응능력 계수</strong></td>
                                <td>가뭄 대응 역량 표준화 계수</td>
                            </tr>
                            <tr>
                                <td rowspan="2" class="text-center bg-white fw-bold text-danger">취약성</td>
                                <td><strong>취약성 점수</strong></td>
                                <td>종합 가뭄 취약성 점수</td>
                            </tr>
                            <tr>
                                <td><strong>취약성 등급</strong></td>
                                <td>1(관심) ~ 5(매우심각) 등급</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-secondary w-100" data-bs-dismiss="modal">닫기</button>
            </div>
        </div>
    </div>
    </div>

<div class="modal fade" id="consoleModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title d-flex align-items-center">
                        <i class="fa-solid fa-terminal me-2 text-success"></i>SPARQL Expert Console
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body bg-light p-0">
                    <ul class="nav nav-tabs nav-fill bg-white border-bottom" id="consoleTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="query-tab" data-bs-toggle="tab" data-bs-target="#query-panel" type="button" role="tab">
                                <i class="fa-solid fa-code me-2"></i>Query Editor
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="vocab-tab" data-bs-toggle="tab" data-bs-target="#vocab-panel" type="button" role="tab">
                                <i class="fa-solid fa-book me-2"></i>Vocabulary Dictionary
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="ttl-tab" data-bs-toggle="tab" data-bs-target="#ttl-panel" type="button" role="tab">
                                <i class="fa-solid fa-file-code me-2"></i>Full Knowledge Graph (TTL)
                            </button>
                        </li>
                    </ul>

                    <div class="tab-content p-3" id="consoleTabContent">
                        
                        <div class="tab-pane fade show active" id="query-panel" role="tabpanel">
                            
                            <div class="alert alert-secondary py-2 px-3 mb-2 small">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span>
                                        <i class="fa-solid fa-circle-check text-success me-2"></i><strong>Prefix 자동 적용됨:</strong> kodv, koad, rdfs, skos, etc.
                                    </span>
                                    <button class="btn btn-sm btn-outline-dark" type="button" data-bs-toggle="collapse" data-bs-target="#prefixCollapse" aria-expanded="false">
                                        <i class="fa-solid fa-list me-1"></i>Prefix 목록 보기
                                    </button>
                                </div>
                                
                                <div class="collapse mt-2" id="prefixCollapse">
                                    <div class="card card-body bg-white border p-0 overflow-hidden">
                                        <table class="table table-sm table-striped mb-0 table-bordered" style="font-size: 0.85rem;">
                                            <thead class="table-light">
                                                <tr>
                                                    <th style="width: 15%" class="text-center">Prefix</th>
                                                    <th>Namespace URI</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr><td class="text-center fw-bold">kodv</td><td class="font-monospace text-muted">&lt;https://knowledgemap.kr/kodv/def/&gt;</td></tr>
                                                <tr><td class="text-center fw-bold">kodvid</td><td class="font-monospace text-muted">&lt;https://knowledgemap.kr/kodv/id/&gt;</td></tr>
                                                <tr><td class="text-center fw-bold">koad</td><td class="font-monospace text-muted">&lt;http://vocab.datahub.kr/def/administrative-division/&gt;</td></tr>
                                                <tr><td class="text-center fw-bold">rdfs</td><td class="font-monospace text-muted">&lt;http://www.w3.org/2000/01/rdf-schema#&gt;</td></tr>
                                                <tr><td class="text-center fw-bold">skos</td><td class="font-monospace text-muted">&lt;http://www.w3.org/2004/02/skos/core#&gt;</td></tr>
                                                <tr><td class="text-center fw-bold">qudt</td><td class="font-monospace text-muted">&lt;http://qudt.org/schema/qudt/&gt;</td></tr>
                                                <tr><td class="text-center fw-bold">unit</td><td class="font-monospace text-muted">&lt;http://qudt.org/vocab/unit/&gt;</td></tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <div class="d-flex justify-content-end mb-1">
                                    <span class="badge bg-danger me-1"><i class="fa-solid fa-ban me-1"></i>DELETE/UPDATE 금지</span>
                                    <span class="badge bg-success"><i class="fa-solid fa-check me-1"></i>SELECT 허용</span>
                                </div>
                                
                                <textarea id="console-input" class="form-control console-textarea p-3 font-monospace" rows="10" spellcheck="false" 
                                style="background-color: #1e1e1e; color: #d4d4d4; border: 1px solid #333; font-size: 0.95rem;">
SELECT ?name ?pop
WHERE {
  ?s a koad:Dong ;
     rdfs:label ?name ;
     kodv:population ?pop .
}
ORDER BY DESC(?pop)
LIMIT 5</textarea>
                            </div>

                            <button class="btn btn-primary w-100 fw-bold py-2 shadow-sm" onclick="runConsoleQuery()">
                                <i class="fa-solid fa-play me-2"></i> 쿼리 실행 (Execute)
                            </button>
                            
                            <hr class="my-4">
                            
                            <label class="form-label fw-bold"><i class="fa-solid fa-table me-2"></i>실행 결과 (Result)</label>
                            <div class="table-responsive bg-white border rounded" style="max-height: 250px; min-height: 100px;">
                                <table class="table table-sm table-hover table-striped mb-0 small" id="console-result-table">
                                    <thead class="table-light sticky-top"><tr><th class="p-3 text-center text-muted">결과가 여기에 표시됩니다.</th></tr></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="vocab-panel" role="tabpanel">
                            <div class="alert alert-info py-2 small mb-2">
                                <i class="fa-solid fa-info-circle me-2"></i>KODV 프로젝트에서 사용된 모든 어휘 및 매핑 정보입니다.
                            </div>
                            <div class="table-responsive border rounded bg-white shadow-sm" style="height: 600px; overflow-y: auto;">
                                <table class="table table-hover table-bordered mb-0 small">
                                    <thead class="table-light sticky-top">
                                        <tr class="text-center">
                                            <th style="width: 12%">유형</th>
                                            <th style="width: 30%">어휘 (Vocabulary)</th>
                                            <th style="width: 18%">항목명 (Label)</th>
                                            <th>설명 (Description)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr class="table-secondary">
                                            <td colspan="4" class="fw-bold ps-3">1. 행정구역 표준 클래스 (koad)</td>
                                        </tr>
                                        <tr>
                                            <td><span class="badge bg-primary">Class</span></td>
                                            <td class="font-monospace text-primary">koad:SpecialMetropolitanCity</td>
                                            <td>특별시</td>
                                            <td>서울</td>
                                        </tr>
                                        <tr>
                                            <td><span class="badge bg-primary">Class</span></td>
                                            <td class="font-monospace text-primary">koad:MetropolitanCity</td>
                                            <td>광역시</td>
                                            <td>부산, 인천 등</td>
                                        </tr>
                                        <tr>
                                            <td><span class="badge bg-primary">Class</span></td>
                                            <td class="font-monospace text-primary">koad:SpecialSelfGoverningCity</td>
                                            <td>특별자치시</td>
                                            <td>세종</td>
                                        </tr>
                                        <tr>
                                            <td><span class="badge bg-primary">Class</span></td>
                                            <td class="font-monospace text-primary">koad:Province</td>
                                            <td>도</td>
                                            <td>경기, 강원 등</td>
                                        </tr>
                                        <tr>
                                            <td><span class="badge bg-primary">Class</span></td>
                                            <td class="font-monospace text-primary">koad:SpecialSelfGoverningProvince</td>
                                            <td>특별자치도</td>
                                            <td>제주, 강원</td>
                                        </tr>
                                        <tr>
                                            <td><span class="badge bg-primary">Class</span></td>
                                            <td class="font-monospace text-primary">koad:AdministrativeCity</td>
                                            <td>행정시</td>
                                            <td>제주시, 서귀포시 등</td>
                                        </tr>
                                        <tr>
                                            <td><span class="badge bg-primary">Class</span></td>
                                            <td class="font-monospace text-primary">koad:SpecialCity</td>
                                            <td>특례시</td>
                                            <td>수원, 용인 등</td>
                                        </tr>
                                        <tr>
                                            <td><span class="badge bg-primary">Class</span></td>
                                            <td class="font-monospace text-primary">koad:City</td>
                                            <td>시</td>
                                            <td>일반 시</td>
                                        </tr>
                                        <tr>
                                            <td><span class="badge bg-primary">Class</span></td>
                                            <td class="font-monospace text-primary">koad:County</td>
                                            <td>군</td>
                                            <td>군 지역</td>
                                        </tr>
                                        <tr>
                                            <td><span class="badge bg-primary">Class</span></td>
                                            <td class="font-monospace text-primary">koad:District</td>
                                            <td>구 (자치구)</td>
                                            <td>특별시/광역시 산하</td>
                                        </tr>
                                        <tr>
                                            <td><span class="badge bg-primary">Class</span></td>
                                            <td class="font-monospace text-primary">koad:NonAutonomousDistrict</td>
                                            <td>구 (행정구)</td>
                                            <td>수원 팔달구 등</td>
                                        </tr>
                                        <tr>
                                            <td><span class="badge bg-primary">Class</span></td>
                                            <td class="font-monospace text-primary">koad:Eup</td>
                                            <td>읍 (행정읍)</td>
                                            <td>하위 행정구역</td>
                                        </tr>
                                        <tr>
                                            <td><span class="badge bg-primary">Class</span></td>
                                            <td class="font-monospace text-primary">koad:Myeon</td>
                                            <td>면 (행정면)</td>
                                            <td>하위 행정구역</td>
                                        </tr>
                                        <tr>
                                            <td><span class="badge bg-primary">Class</span></td>
                                            <td class="font-monospace text-primary">koad:Dong</td>
                                            <td>동 (행정동)</td>
                                            <td>하위 행정구역</td>
                                        </tr>
                                        
                                        <tr class="table-secondary">
                                            <td colspan="4" class="fw-bold ps-3">2. 행정구역 데이터 속성 및 관계 (koad)</td>
                                        </tr>
                                        <tr>
                                            <td><span class="badge bg-secondary">Annotation</span></td>
                                            <td class="font-monospace text-dark">rdfs:label</td>
                                            <td>시도명/시군명/읍면동명</td>
                                            <td>사람이 읽을 수 있는 명칭</td>
                                        </tr>
                                        <tr>
                                            <td><span class="badge bg-info text-dark">Data Prop</span></td>
                                            <td class="font-monospace text-dark">koad:divisionCode</td>
                                            <td>행정구역코드</td>
                                            <td>Unique ID (String)</td>
                                        </tr>
                                        <tr>
                                            <td><span class="badge bg-warning text-dark">Obj Prop (Up)</span></td>
                                            <td class="font-monospace text-dark">koad:isCityOf</td>
                                            <td>(관계) ~에 속한 시</td>
                                            <td>기초 -> 광역 (역관계)</td>
                                        </tr>
                                        <tr>
                                            <td><span class="badge bg-warning text-dark">Obj Prop (Up)</span></td>
                                            <td class="font-monospace text-dark">koad:isCountyOf</td>
                                            <td>(관계) ~에 속한 군</td>
                                            <td>기초 -> 광역 (역관계)</td>
                                        </tr>
                                        <tr>
                                            <td><span class="badge bg-warning text-dark">Obj Prop (Up)</span></td>
                                            <td class="font-monospace text-dark">koad:isDistrictOf</td>
                                            <td>(관계) ~에 속한 구</td>
                                            <td>기초 -> 광역 (역관계)</td>
                                        </tr>
                                        <tr>
                                            <td><span class="badge bg-warning text-dark">Obj Prop (Up)</span></td>
                                            <td class="font-monospace text-dark">koad:isTownOf</td>
                                            <td>(관계) ~에 속한 읍</td>
                                            <td>하위 -> 기초 (역관계)</td>
                                        </tr>
                                        <tr>
                                            <td><span class="badge bg-warning text-dark">Obj Prop (Up)</span></td>
                                            <td class="font-monospace text-dark">koad:isTownshipOf</td>
                                            <td>(관계) ~에 속한 면</td>
                                            <td>하위 -> 기초 (역관계)</td>
                                        </tr>
                                        <tr>
                                            <td><span class="badge bg-warning text-dark">Obj Prop (Up)</span></td>
                                            <td class="font-monospace text-dark">koad:isNeighborhoodOf</td>
                                            <td>(관계) ~에 속한 동</td>
                                            <td>하위 -> 기초 (역관계)</td>
                                        </tr>
                                        
                                        <tr class="table-secondary">
                                            <td colspan="4" class="fw-bold ps-3">3. 가뭄 데이터 속성 (kodv - L3 전용)</td>
                                        </tr>
                                        <tr>
                                            <td><span class="badge bg-info text-dark">Data Prop</span></td>
                                            <td class="font-monospace text-dark">kodv:population</td>
                                            <td>인구</td>
                                            <td>거주 총 인구수</td>
                                        </tr>
                                        <tr>
                                            <td><span class="badge bg-info text-dark">Data Prop</span></td>
                                            <td class="font-monospace text-dark">kodv:waterSupplyRate</td>
                                            <td>급수율</td>
                                            <td>상수도 보급률(%)</td>
                                        </tr>
                                        <tr>
                                            <td><span class="badge bg-info text-dark">Data Prop</span></td>
                                            <td class="font-monospace text-dark">kodv:waterSupplyPopulation</td>
                                            <td>급수인구</td>
                                            <td>상수도 공급 인구</td>
                                        </tr>
                                        <tr>
                                            <td><span class="badge bg-info text-dark">Data Prop</span></td>
                                            <td class="font-monospace text-dark">kodv:droughtSeverityAvg</td>
                                            <td>평균가뭄심도</td>
                                            <td>기상학적 가뭄지수(SPI) 평균</td>
                                        </tr>
                                        <tr>
                                            <td><span class="badge bg-info text-dark">Data Prop</span></td>
                                            <td class="font-monospace text-dark">kodv:droughtFrequency</td>
                                            <td>가뭄발생빈도</td>
                                            <td>과거 가뭄 발생 횟수</td>
                                        </tr>
                                        <tr>
                                            <td><span class="badge bg-info text-dark">Data Prop</span></td>
                                            <td class="font-monospace text-dark">kodv:droughtExposureScore</td>
                                            <td>가뭄노출도</td>
                                            <td>심도+빈도 종합 점수</td>
                                        </tr>
                                        <tr>
                                            <td><span class="badge bg-info text-dark">Data Prop</span></td>
                                            <td class="font-monospace text-dark">kodv:exposureCoefficient</td>
                                            <td>노출도계수</td>
                                            <td>노출도 표준화 계수</td>
                                        </tr>
                                        <tr>
                                            <td><span class="badge bg-info text-dark">Data Prop</span></td>
                                            <td class="font-monospace text-dark">kodv:domesticWaterUsage</td>
                                            <td>생활용수이용량</td>
                                            <td>가정 등 일상생활 용수량</td>
                                        </tr>
                                        <tr>
                                            <td><span class="badge bg-info text-dark">Data Prop</span></td>
                                            <td class="font-monospace text-dark">kodv:industrialWaterUsage</td>
                                            <td>공업용수이용량</td>
                                            <td>산업 생산 활동 용수량</td>
                                        </tr>
                                        <tr>
                                            <td><span class="badge bg-info text-dark">Data Prop</span></td>
                                            <td class="font-monospace text-dark">kodv:sensitivityCoefficient</td>
                                            <td>민감도 계수</td>
                                            <td>피해 가능성 표준화 계수</td>
                                        </tr>
                                        <tr>
                                            <td><span class="badge bg-info text-dark">Data Prop</span></td>
                                            <td class="font-monospace text-dark">kodv:reservoirCapacity</td>
                                            <td>저수지 유효저수량</td>
                                            <td>관개/용수 공급 가능량</td>
                                        </tr>
                                        <tr>
                                            <td><span class="badge bg-info text-dark">Data Prop</span></td>
                                            <td class="font-monospace text-dark">kodv:groundwaterAvailable</td>
                                            <td>지하수 개발가능량</td>
                                            <td>지속 이용 가능한 지하수량</td>
                                        </tr>
                                        <tr>
                                            <td><span class="badge bg-info text-dark">Data Prop</span></td>
                                            <td class="font-monospace text-dark">kodv:domesticIndustrialWaterUsage</td>
                                            <td>생·공용수 이용량</td>
                                            <td>생활+공업 용수 합계</td>
                                        </tr>
                                        <tr>
                                            <td><span class="badge bg-info text-dark">Data Prop</span></td>
                                            <td class="font-monospace text-dark">kodv:auxWaterSourceCapacity</td>
                                            <td>보조수원능력</td>
                                            <td>비상시 물 공급 잠재력</td>
                                        </tr>
                                        <tr>
                                            <td><span class="badge bg-info text-dark">Data Prop</span></td>
                                            <td class="font-monospace text-dark">kodv:auxWaterSourceCoefficient</td>
                                            <td>보조수원계수</td>
                                            <td>보조수원능력 표준화 계수</td>
                                        </tr>
                                        <tr>
                                            <td><span class="badge bg-info text-dark">Data Prop</span></td>
                                            <td class="font-monospace text-dark">kodv:waterSupplyAvailableDays</td>
                                            <td>용수공급 가능일수</td>
                                            <td>가용 수자원 지속 일수</td>
                                        </tr>
                                        <tr>
                                            <td><span class="badge bg-info text-dark">Data Prop</span></td>
                                            <td class="font-monospace text-dark">kodv:responseCapacityCoefficient</td>
                                            <td>대응능력계수</td>
                                            <td>가뭄 대응 역량 표준화 계수</td>
                                        </tr>
                                        <tr>
                                            <td><span class="badge bg-info text-dark">Data Prop</span></td>
                                            <td class="font-monospace text-dark">kodv:vulnerabilityScore</td>
                                            <td>취약성</td>
                                            <td>최종 가뭄 취약성 점수</td>
                                        </tr>
                                        <tr>
                                            <td><span class="badge bg-warning text-dark">Obj Prop</span></td>
                                            <td class="font-monospace text-dark">kodv:vulnerabilityRating</td>
                                            <td>취약성등급 (URI)</td>
                                            <td>I~V 등급 개념 연결</td>
                                        </tr>
                                        <tr>
                                            <td><span class="badge bg-info text-dark">Data Prop</span></td>
                                            <td class="font-monospace text-dark">kodv:vulnerabilityRatingNumeric</td>
                                            <td>취약성 등급 (숫자)</td>
                                            <td>1~5 정수 (정렬/비교 쿼리용)</td>
                                        </tr>
                                        
                                        <tr class="table-secondary">
                                            <td colspan="4" class="fw-bold ps-3">4. SKOS 표준 어휘 (분류 체계 정의용)</td>
                                        </tr>
                                        <tr>
                                            <td><span class="badge bg-primary">Class</span></td>
                                            <td class="font-monospace text-primary">skos:Concept</td>
                                            <td>개념 (Concept)</td>
                                            <td>지식 분류의 개별 아이디어</td>
                                        </tr>
                                        <tr>
                                            <td><span class="badge bg-primary">Class</span></td>
                                            <td class="font-monospace text-primary">skos:ConceptScheme</td>
                                            <td>개념 분류 체계</td>
                                            <td>개념들의 집합(스키마)</td>
                                        </tr>
                                        <tr>
                                            <td><span class="badge bg-primary">Class</span></td>
                                            <td class="font-monospace text-primary">skos:OrderedCollection</td>
                                            <td>순서있는 집합</td>
                                            <td>순서가 정의된 개념 모음</td>
                                        </tr>
                                        <tr>
                                            <td><span class="badge bg-secondary">Annotation</span></td>
                                            <td class="font-monospace text-dark">skos:prefLabel</td>
                                            <td>대표 이름</td>
                                            <td>개념의 공식 명칭</td>
                                        </tr>
                                        <tr>
                                            <td><span class="badge bg-secondary">Annotation</span></td>
                                            <td class="font-monospace text-dark">skos:definition</td>
                                            <td>개념 정의</td>
                                            <td>개념의 뜻 풀이</td>
                                        </tr>
                                        <tr>
                                            <td><span class="badge bg-secondary">Annotation</span></td>
                                            <td class="font-monospace text-dark">skos:altLabel</td>
                                            <td>대체 이름</td>
                                            <td>동의어 또는 별칭</td>
                                        </tr>
                                        <tr>
                                            <td><span class="badge bg-warning text-dark">Obj Prop</span></td>
                                            <td class="font-monospace text-dark">skos:hasTopConcept</td>
                                            <td>(관계) 최상위 개념을 가짐</td>
                                            <td>스키마와 최상위 개념 연결</td>
                                        </tr>
                                        <tr>
                                            <td><span class="badge bg-warning text-dark">Obj Prop</span></td>
                                            <td class="font-monospace text-dark">skos:inScheme</td>
                                            <td>(관계) 분류표에 속함</td>
                                            <td>개념이 속한 스키마 명시</td>
                                        </tr>
                                        <tr>
                                            <td><span class="badge bg-warning text-dark">Obj Prop</span></td>
                                            <td class="font-monospace text-dark">skos:memberList</td>
                                            <td>(관계) 멤버 목록</td>
                                            <td>컬렉션의 순서 정의 리스트</td>
                                        </tr>
                                        
                                        <tr class="table-secondary">
                                            <td colspan="4" class="fw-bold ps-3">5. KODV 온톨로지 분류 체계 (kodvid)</td>
                                        </tr>
                                        <tr>
                                            <td><span class="badge bg-warning text-dark">Instance</span></td>
                                            <td class="font-monospace">kodvid:droughtVulnerability</td>
                                            <td>가뭄 지표 분류</td>
                                            <td>Concept Scheme (전체 분류)</td>
                                        </tr>
                                        <tr>
                                            <td><span class="badge bg-warning text-dark">Instance</span></td>
                                            <td class="font-monospace">kodvid:WaterSupplyInfo</td>
                                            <td>급수 인구 정보</td>
                                            <td>Top Concept</td>
                                        </tr>
                                        <tr>
                                            <td><span class="badge bg-warning text-dark">Instance</span></td>
                                            <td class="font-monospace">kodvid:Exposure</td>
                                            <td>노출도 평가결과</td>
                                            <td>Top Concept</td>
                                        </tr>
                                        <tr>
                                            <td><span class="badge bg-warning text-dark">Instance</span></td>
                                            <td class="font-monospace">kodvid:Sensitivity</td>
                                            <td>민감도 평가결과</td>
                                            <td>Top Concept</td>
                                        </tr>
                                        <tr>
                                            <td><span class="badge bg-warning text-dark">Instance</span></td>
                                            <td class="font-monospace">kodvid:AuxWaterSource</td>
                                            <td>보조수원능력 평가결과</td>
                                            <td>Top Concept</td>
                                        </tr>
                                        <tr>
                                            <td><span class="badge bg-warning text-dark">Instance</span></td>
                                            <td class="font-monospace">kodvid:ResponseCapacity</td>
                                            <td>가뭄대응능력 평가결과</td>
                                            <td>Top Concept</td>
                                        </tr>
                                        <tr>
                                            <td><span class="badge bg-warning text-dark">Instance</span></td>
                                            <td class="font-monospace">kodvid:Vulnerability</td>
                                            <td>가뭄취약성 평가결과</td>
                                            <td>Top Concept</td>
                                        </tr>
                                        <tr>
                                            <td><span class="badge bg-warning text-dark">Instance</span></td>
                                            <td class="font-monospace">kodvid:RatingScale</td>
                                            <td>취약성 등급 척도</td>
                                            <td>Ordered Collection (5단계)</td>
                                        </tr>
                                        <tr>
                                            <td><span class="badge bg-warning text-dark">Instance</span></td>
                                            <td class="font-monospace">kodvid:Rating_I</td>
                                            <td>I 등급 (관심)</td>
                                            <td>Concept (취약성 등급)</td>
                                        </tr>
                                        <tr>
                                            <td><span class="badge bg-warning text-dark">Instance</span></td>
                                            <td class="font-monospace">kodvid:Rating_II</td>
                                            <td>II 등급 (주의)</td>
                                            <td>Concept (취약성 등급)</td>
                                        </tr>
                                        <tr>
                                            <td><span class="badge bg-warning text-dark">Instance</span></td>
                                            <td class="font-monospace">kodvid:Rating_III</td>
                                            <td>III 등급 (경계)</td>
                                            <td>Concept (취약성 등급)</td>
                                        </tr>
                                        <tr>
                                            <td><span class="badge bg-warning text-dark">Instance</span></td>
                                            <td class="font-monospace">kodvid:Rating_IV</td>
                                            <td>IV 등급 (심각)</td>
                                            <td>Concept (취약성 등급)</td>
                                        </tr>
                                        <tr>
                                            <td><span class="badge bg-warning text-dark">Instance</span></td>
                                            <td class="font-monospace">kodvid:Rating_V</td>
                                            <td>V 등급 (매우심각)</td>
                                            <td>Concept (취약성 등급)</td>
                                        </tr>
                                        
                                        <tr class="table-secondary">
                                            <td colspan="4" class="fw-bold ps-3">6. 외부 표준 어휘 (Schema, DC, XSD, QUDT, OWL)</td>
                                        </tr>
                                        <tr>
                                            <td><span class="badge bg-secondary">Annotation</span></td>
                                            <td class="font-monospace text-dark">schema:unitText</td>
                                            <td>단위 텍스트</td>
                                            <td>사람이 보는 단위 표시</td>
                                        </tr>
                                        <tr>
                                            <td><span class="badge bg-secondary">Annotation</span></td>
                                            <td class="font-monospace text-dark">dcterms:title</td>
                                            <td>제목 (Title)</td>
                                            <td>스키마 공식 명칭</td>
                                        </tr>
                                        <tr>
                                            <td><span class="badge bg-secondary">Annotation</span></td>
                                            <td class="font-monospace text-dark">dcterms:description</td>
                                            <td>설명 (Description)</td>
                                            <td>상세 설명</td>
                                        </tr>
                                        <tr>
                                            <td><span class="badge bg-secondary">Annotation</span></td>
                                            <td class="font-monospace text-dark">dcterms:identifier</td>
                                            <td>식별자 (Identifier)</td>
                                            <td>고유 식별자</td>
                                        </tr>
                                        <tr>
                                            <td><span class="badge bg-warning text-dark">Obj Prop</span></td>
                                            <td class="font-monospace text-dark">dcterms:subject</td>
                                            <td>주제 (Subject)</td>
                                            <td>속성과 개념 연결</td>
                                        </tr>
                                        <tr>
                                            <td><span class="badge bg-secondary">Annotation</span></td>
                                            <td class="font-monospace text-dark">rdfs:comment</td>
                                            <td>주석 (Comment)</td>
                                            <td>부가 설명</td>
                                        </tr>
                                        <tr>
                                            <td><span class="badge bg-warning text-dark">Obj Prop</span></td>
                                            <td class="font-monospace text-dark">rdfs:range</td>
                                            <td>값의 범위 (Range)</td>
                                            <td>속성 값의 타입 정의</td>
                                        </tr>
                                        <tr>
                                            <td><span class="badge bg-danger">Datatype</span></td>
                                            <td class="font-monospace text-dark">xsd:string</td>
                                            <td>(타입) 문자열</td>
                                            <td>Text 형식 값</td>
                                        </tr>
                                        <tr>
                                            <td><span class="badge bg-danger">Datatype</span></td>
                                            <td class="font-monospace text-dark">xsd:integer</td>
                                            <td>(타입) 정수</td>
                                            <td>소수점 없는 숫자</td>
                                        </tr>
                                        <tr>
                                            <td><span class="badge bg-danger">Datatype</span></td>
                                            <td class="font-monospace text-dark">xsd:decimal</td>
                                            <td>(타입) 실수</td>
                                            <td>소수점 포함 숫자</td>
                                        </tr>
                                        <tr>
                                            <td><span class="badge bg-danger">Datatype</span></td>
                                            <td class="font-monospace text-dark">xsd:anyURI</td>
                                            <td>(타입) URI</td>
                                            <td>URI 형식 값</td>
                                            <td></td>
                                        </tr>
                                        <tr>
                                            <td><span class="badge bg-warning text-dark">Obj Prop</span></td>
                                            <td class="font-monospace text-dark">qudt:hasQuantityKind</td>
                                            <td>물리량 종류</td>
                                            <td>데이터의 물리적 차원</td>
                                        </tr>
                                        <tr>
                                            <td><span class="badge bg-warning text-dark">Obj Prop</span></td>
                                            <td class="font-monospace text-dark">qudt:unit</td>
                                            <td>측정 단위</td>
                                            <td>데이터의 단위 연결</td>
                                        </tr>
                                        <tr>
                                            <td><span class="badge bg-warning text-dark">Obj Prop</span></td>
                                            <td class="font-monospace text-dark">owl:sameAs</td>
                                            <td>동일 개체</td>
                                            <td>다른 URI와 동일함 명시</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="ttl-panel" role="tabpanel">
                            <div class="alert alert-secondary py-2 small mb-2 d-flex justify-content-between align-items-center">
                                <span><i class="fa-solid fa-file-lines me-2"></i>"KODV의 전체 지식그래프(Schema + Instance) 소스 코드입니다. (총 88,918 Triples)"</span>
                                <span id="ttl-loading" class="text-primary fw-bold" style="display:none;">
                                    <i class="fa-solid fa-spinner fa-spin me-1"></i>Loading...
                                </span>
                            </div>
                            
                            <div class="position-relative">
                                <pre id="ttl-content" class="bg-dark text-light p-3 rounded border border-secondary shadow-sm" 
                                     style="height: 600px; overflow-y: auto; font-size: 0.85rem; line-height: 1.5;">
(파일을 불러오려면 'Ontology Example' 탭을 클릭하세요...)
                                </pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="map"></div>

    <div class="modal fade" id="easyQueryModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header text-white" style="background-color: #198754;">
                    <h5 class="modal-title fw-bold"><i class="fas fa-magic me-2"></i>데이터 탐색기 (Easy Query)</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body bg-light">
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold small text-success">STEP 1. 지역 선택 (Where)</label>
                        <select id="eq-region" class="form-select" onchange="updateEasyPreview()">
                            <option value="">전국 (All Regions)</option>
                            <option value="서울특별시">서울특별시</option>
                            <option value="경기도">경기도</option>
                            <option value="충청남도">충청남도</option>
                            <option value="충청북도">충청북도</option>
                            <option value="전라남도">전라남도</option>
                            <option value="전북특별자치도">전북특별자치도</option>
                            <option value="경상남도">경상남도</option>
                            <option value="경상북도">경상북도</option>
                            <option value="강원특별자치도">강원특별자치도</option>
                            <option value="제주특별자치도">제주특별자치도</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold small text-success">STEP 2. 데이터 속성 (What)</label>
                        <select id="eq-attribute" class="form-select" onchange="updateEasyPreview()">
                            </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold small text-success">STEP 3. 필터 조건 (Condition)</label>
                        <div class="input-group">
                            <select id="eq-condition" class="form-select" style="max-width: 130px;" onchange="updateEasyPreview()">
                                <option value="TOP">상위 (Top)</option>
                                <option value="BOTTOM">하위 (Bottom)</option>
                                <option value="GTE">~이상 (>=)</option>
                                <option value="LTE">~이하 (<=)</option>
                            </select>
                            <input type="number" id="eq-value" class="form-control" placeholder="개수 또는 값" value="10" oninput="updateEasyPreview()">
                        </div>
                        <div class="form-text text-muted" id="eq-hint">예: 값이 높은 순서대로 10개 지역을 찾습니다.</div>
                    </div>

                    <div class="card bg-dark border-0 mb-3">
                        <div class="card-body p-2">
                            <div class="d-flex justify-content-between mb-1">
                                <span class="text-secondary small" style="font-size: 0.7rem;">GENERATED SPARQL PREVIEW</span>
                                <span class="badge bg-secondary" style="font-size: 0.6rem;">L3 (읍면동) 기준</span>
                            </div>
                            <pre id="eq-preview" class="text-success mb-0 small font-monospace" style="white-space: pre-wrap; word-break: break-all;">SELECT...</pre>
                        </div>
                    </div>

                    <button class="btn btn-success w-100 fw-bold shadow-sm" onclick="runEasyQuery()">
                        <i class="fas fa-search me-2"></i>결과 조회하기
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>
        // [설정] 데이터 속성별 라벨/단위/아이콘 매핑 (19종 전체 + 메타데이터)
            const ATTR_MAP = {
                // [1. 급수 인구 정보]
                'population': { label: '인구', unit: '명', icon: 'fa-users', color: 'primary' },
                'waterSupplyRate': { label: '급수율', unit: '%', icon: 'fa-faucet', color: 'primary' },
                'waterSupplyPopulation': { label: '급수인구', unit: '명', icon: 'fa-user-check', color: 'primary' },

                // [2. 노출도]
                'droughtSeverityAvg': { label: '평균가뭄심도', unit: '', icon: 'fa-sun', color: 'warning' },
                'droughtFrequency': { label: '가뭄빈도', unit: '회', icon: 'fa-calendar-day', color: 'warning' },
                'droughtExposureScore': { label: '노출도', unit: '점', icon: 'fa-chart-line', color: 'warning' },
                'exposureCoefficient': { label: '노출도계수', unit: '', icon: 'fa-calculator', color: 'warning' },

                // [3. 민감도]
                'domesticWaterUsage': { label: '생활용수', unit: '㎥', icon: 'fa-house-chimney', color: 'success' },
                'industrialWaterUsage': { label: '공업용수', unit: '㎥', icon: 'fa-industry', color: 'success' },
                'livingIndustrialWaterUsage': { label: '생·공용수', unit: '㎥', icon: 'fa-faucet-drip', color: 'success' },
                'sensitivityCoefficient': { label: '민감도계수', unit: '', icon: 'fa-calculator', color: 'success' },

                // [4. 보조수원]
                'reservoirCapacity': { label: '저수지용량', unit: '천㎥', icon: 'fa-water', color: 'info' },
                'groundwaterAvailable': { label: '지하수량', unit: '천㎥', icon: 'fa-arrow-up-from-bracket', color: 'info' },
                'auxWaterSourceCapacity': { label: '보조수원능력', unit: '', icon: 'fa-hand-holding-droplet', color: 'info' },
                'auxWaterSourceCoefficient': { label: '보조수원계수', unit: '', icon: 'fa-calculator', color: 'info' },

                // [5. 대응능력]
                'waterSupplyAvailableDays': { label: '공급가능일수', unit: '일', icon: 'fa-calendar-check', color: 'secondary' },
                'responseCapacityCoefficient': { label: '대응능력계수', unit: '', icon: 'fa-calculator', color: 'secondary' },

                // [6. 취약성]
                'vulnerabilityScore': { label: '취약성점수', unit: '점', icon: 'fa-triangle-exclamation', color: 'danger' },
                'vulnerabilityRating': { label: '등급', unit: '', icon: 'fa-layer-group', color: 'danger' },
                'vulnerabilityRatingNumeric': { label: '등급(수치)', unit: '급', icon: 'fa-layer-group', color: 'danger' },

                // [기타]
                'val': { label: '값', unit: '', icon: 'fa-check', color: 'secondary' },
                'count': { label: '개수', unit: '개', icon: 'fa-list-ol', color: 'dark' }
            };
        
        //지도 생성 (대한민국 중심, 축소만 제한하고 이동은 자유롭게)
        var map = L.map('map', {
            // maxBounds 삭제: 이제 지도를 마음껏 끌어서 움직일 수 있습니다.
            minZoom: 7, // 너무 작게 축소해서 지구가 다 보이는 건 방지
            maxZoom: 18 // 최대 확대 제한
        }).setView([36.5, 127.5], 7);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { 
            attribution: '&copy; CARTO', 
            maxZoom: 19 
        }).addTo(map);

        var sidoLayer, sigLayer, emdLayer, dbCodes = [], highlightLayer;
        var lastSparql = "";

        function showLoading(show, text="로딩 중...") { 
            $('#loading .mt-3').text(text);
            $('#loading').css('display', show ? 'block' : 'none'); 
        }

        function fixName(name) {
            if (name === "강원도") return "강원특별자치도";
            if (name === "전라북도") return "전북특별자치도";
            return name;
        }

        function getProps(feature) {
            var p = feature.properties;
            var code = String(p.CTPRVN_CD || p.CTP_RVN_CD || p.SIG_CD || p.sig_cd || p.adm_cd2 || p.adm_cd || "");
            var name = p.CTP_KOR_NM || p.ctp_kor_nm || p.SIG_KOR_NM || p.sig_kor_nm || p.adm_nm || p.name || "이름없음";
            return { code: code, name: fixName(name) };
        }

        showLoading(true);
        $.getJSON("/api/existing-codes", function(codes) {
            dbCodes = codes;
            $.getJSON("{{ url_for('static', filename='sido.json') }}", function(data) {
                sidoLayer = L.geoJson(data, { style: styleSido, onEachFeature: onEachRegion });
                sidoLayer.addTo(map);
                $.getJSON("{{ url_for('static', filename='sig.json') }}", function(data) {
                    sigLayer = L.geoJson(data, { style: styleSig, onEachFeature: onEachRegion });
                    $.getJSON("{{ url_for('static', filename='emd.geojson') }}", function(data) {
                        emdLayer = L.geoJson(data, { style: styleEmd, onEachFeature: onEachRegion });
                        showLoading(false);
                        updateLayer();
                    });
                });
            });
        });

        function styleSido(f) { return { color: "#2c3e50", weight: 2, opacity: 0.8, fillColor: "transparent", fillOpacity: 0 }; }
        function styleSig(f) { return { color: "#5e72e4", weight: 1.5, opacity: 0.6, fillColor: "#5e72e4", fillOpacity: 0.05 }; }
        function styleEmd(f) { return { color: "#fb6340", weight: 1, opacity: 0.8, fillColor: "#fb6340", fillOpacity: 0.1 }; }

        // 1. 각 지역 레이어 설정 함수 (L1 호버 개선 & 기능 통합)
            function onEachRegion(feature, layer) {
                var props = getProps(feature);
                var code = String(props.code);
                var name = props.name;

                layer.bindTooltip(`<b>${name}</b>`, { direction: "top", sticky: true });

                // [수정 1] 호버 스타일 개선 (L1도 면 색칠 + 앞으로 가져오기)
                layer.on('mouseover', function () {
                    this.setStyle({
                        fillOpacity: 0.5,
                        weight: 3,
                        color: "#555",       // 테두리 진회색
                        fillColor: "#888"    // 면 회색 (기존 색상 위에 덮어씌움)
                    });

                    // ★ 핵심: 호버된 지역을 가장 위로 올려서 테두리 겹침 해결
                    if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
                        this.bringToFront();
                    }
                });

                layer.on('mouseout', function () {
                    var defStyle;
                    if (code.length === 2) defStyle = styleSido;
                    else if (code.length === 5) defStyle = styleSig;
                    else defStyle = styleEmd;

                    if (typeof defStyle === 'function') {
                        this.setStyle(defStyle());
                    } else {
                        this.setStyle({ fillOpacity: 0.2, weight: 1, color: "white" });
                    }
                });

                // 클릭 이벤트 (팝업)
                layer.on('click', function (e) {
                    if (!code) return;

                    showLoading(true, "상세 정보 조회 중...");
                    map.panTo(e.latlng, { animate: true, duration: 0.8 });

                    // API 호출
                    $.ajax({
                        url: "/api/data/" + code,
                        dataType: 'json',
                        success: function (res) {
                            showLoading(false);
                            var content = buildPopupHtml(res, name, code, e.latlng);
                            layer.bindPopup(content, { maxWidth: 800 }).openPopup();
                        },
                        error: function () {
                            showLoading(false);
                            // Fallback
                            var dummyRes = { status: "fail" };
                            var content = buildPopupHtml(dummyRes, name, code, e.latlng);
                            layer.bindPopup(content, { maxWidth: 800 }).openPopup();
                        }
                    });
                });

                layer.regionCode = code;
            }

            // 2. 팝업 HTML 생성 함수 (등급별 색상 적용)
            function buildPopupHtml(res, name, code, latlng) {
                var level = (code.length === 2) ? 'L1' : (code.length === 5) ? 'L2' : 'L3';

                var levelBadge = (level === 'L1') ? '<span class="badge bg-dark ms-2" style="font-size:0.7rem;">광역</span>' :
                    (level === 'L2') ? '<span class="badge bg-secondary ms-2" style="font-size:0.7rem;">기초</span>' : '';

                var zoomBtn = "";
                if (level !== 'L3') {
                    zoomBtn = `<button class="btn btn-sm btn-outline-primary w-100 mt-3 shadow-sm fw-bold" onclick="zoomToRegion(${latlng.lat}, ${latlng.lng}, '${level}')">
                <i class="fa-solid fa-magnifying-glass-plus me-1"></i>상세 지역 탐색
            </button>`;
                }

                var d = (res.status === "success") ? res.data : {};
                var finalName = (d.label && d.label.value) ? d.label.value : name;
                var desc = (d.desc && d.desc.value) ? d.desc.value : "Wikidata에 상세 설명 정보가 없습니다.";
                var score = d.vulScore ? `${parseFloat(d.vulScore.value).toFixed(2)}점` : "";

                // [수정 2] 등급별 색상 및 라벨 처리 로직
                var gradeRaw = d.gradeLabel ? d.gradeLabel.value : ""; // 예: "I 등급", "IV 등급"
                var gradeObj = { label: "정보없음", class: "bg-secondary", text: "text-muted", border: "border-secondary" };

                if (gradeRaw.includes("I") && !gradeRaw.includes("II") && !gradeRaw.includes("V")) { // I (관심)
                    gradeObj = { label: "I (관심)", class: "bg-success", text: "text-success", border: "border-success" };
                } else if (gradeRaw.includes("II") && !gradeRaw.includes("III")) { // II (주의)
                    gradeObj = { label: "II (주의)", class: "bg-warning text-dark", text: "text-warning", border: "border-warning" };
                } else if (gradeRaw.includes("III")) { // III (경계)
                    gradeObj = { label: "III (경계)", class: "bg-orange", text: "text-orange", border: "border-orange" }; // 별도 style 필요
                } else if (gradeRaw.includes("IV")) { // IV (심각)
                    gradeObj = { label: "IV (심각)", class: "bg-danger", text: "text-danger", border: "border-danger" };
                } else if (gradeRaw.includes("V")) { // V (매우심각)
                    gradeObj = { label: "V (매우심각)", class: "bg-dark-red", text: "text-dark-red", border: "border-dark-red" }; // 별도 style 필요
                } else if (gradeRaw) {
                    gradeObj = { label: gradeRaw, class: "bg-secondary", text: "text-secondary", border: "border-secondary" };
                }

                var gradeBadge = gradeRaw ? `<span class="badge ${gradeObj.class} ms-1 shadow-sm">${gradeObj.label}</span>` : "";

                // 이미지 HTML 생성
                var noImagePlaceholder = "https://upload.wikimedia.org/wikipedia/commons/thumb/a/ac/No_image_available.svg/300px-No_image_available.svg.png";
                var rawImgUrl = (d.image && d.image.value) ? d.image.value : "";
                var imageHtml = "";

                if (!rawImgUrl || rawImgUrl === noImagePlaceholder) {
                    imageHtml = `
                <div class="d-flex flex-column justify-content-center align-items-center bg-light border rounded mb-3" style="height: 180px; text-align: center;">
                    <i class="fa-regular fa-image fa-2x text-secondary mb-2 opacity-50"></i>
                    <span class="text-secondary small fw-bold">이미지 미보유</span>
                    <span class="text-muted" style="font-size: 0.7rem;">(Wikidata Source)</span>
                </div>`;
                } else {
                    imageHtml = `
                <div class="shadow-sm rounded overflow-hidden mb-3 position-relative" style="height: 180px;">
                    <img src="${rawImgUrl}" class="w-100 h-100" style="object-fit: cover; transition: transform 0.3s;" alt="${finalName}">
                    <div class="position-absolute bottom-0 end-0 bg-dark bg-opacity-50 text-white px-2 py-1 small" style="font-size:0.7rem; border-top-left-radius: 5px;">
                        <i class="fa-brands fa-wikipedia-w"></i> Wikidata
                    </div>
                </div>`;
                }

                // [좌측 패널]
                var leftPanel = `
            <div class="p-3 bg-white" style="width: 300px;">
                <div class="d-flex align-items-center mb-3 pe-3">
                    <h5 class="fw-bold text-dark m-0 me-auto text-truncate">
                        <i class="fa-solid fa-location-dot text-primary me-2"></i>${finalName}
                    </h5>
                    ${gradeBadge} ${levelBadge}
                </div>
                
                ${imageHtml}
                
                <div class="mb-3">
                    <div class="text-muted small mb-1 fw-bold"><i class="fa-solid fa-quote-left me-1 text-primary"></i>개요</div>
                    <p class="text-secondary small mb-0 text-truncate-3" style="line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden;">
                        ${desc}
                    </p>
                </div>

                <div class="d-flex justify-content-between align-items-center bg-light p-2 rounded mb-3 border">
                    <span class="small text-muted"><i class="fa-solid fa-barcode me-1"></i>행정코드</span>
                    <span class="font-monospace fw-bold text-dark">${code}</span>
                </div>

                ${score ? `<div class="d-flex justify-content-between align-items-center bg-light p-2 rounded mb-3 border ${gradeObj.border} border-opacity-50">
                    <span class="small ${gradeObj.text} fw-bold"><i class="fa-solid fa-chart-line me-1"></i>취약성 점수</span>
                    <span class="fw-bold ${gradeObj.text}">${score}</span>
                </div>` : ""}

                <div class="d-grid gap-2">
                    <a href="${d.wikiURI ? d.wikiURI.value : '#'}" target="_blank" class="btn btn-sm btn-dark shadow-sm">
                        <i class="fa-brands fa-wikipedia-w me-1"></i>위키데이터 원문 보기
                    </a>
                    ${zoomBtn}
                </div>
            </div>`;

                // [우측 패널] (L3 전용)
                var rightPanel = "";
                if (level === 'L3' && res.status === "success") {
                    const groups = [
                        { name: "급수 인구 정보", color: "text-primary", keys: ['population', 'waterSupplyRate', 'waterSupplyPopulation'] },
                        { name: "노출도 (Exposure)", color: "text-warning", keys: ['droughtSeverityAvg', 'droughtFrequency', 'droughtExposureScore', 'exposureCoefficient'] },
                        { name: "민감도 (Sensitivity)", color: "text-success", keys: ['domesticWaterUsage', 'industrialWaterUsage', 'livingIndustrialWaterUsage', 'sensitivityCoefficient'] },
                        { name: "보조수원 (Auxiliary)", color: "text-info", keys: ['reservoirCapacity', 'groundwaterAvailable', 'auxWaterSourceCapacity', 'auxWaterSourceCoefficient'] },
                        { name: "대응능력 (Response)", color: "text-secondary", keys: ['waterSupplyAvailableDays', 'responseCapacityCoefficient'] }
                    ];

                    const fmt = (val) => val ? Number(val).toLocaleString() : '-';
                    const getVal = (key) => d[key] ? d[key].value : null;

                    let tableRows = "";
                    groups.forEach(g => {
                        tableRows += `<tr class="bg-light border-bottom"><td colspan="2" class="fw-bold ${g.color} pt-2 pb-1 ps-2 small"><i class="fa-solid fa-chevron-right me-1" style="font-size:0.7rem;"></i>${g.name}</td></tr>`;
                        g.keys.forEach(k => {
                            let info = ATTR_MAP[k] || { label: k, unit: '' };
                            let val = getVal(k);
                            if (val) {
                                if (!isNaN(val) && val.indexOf('.') !== -1) val = parseFloat(val).toFixed(2);
                                else val = Number(val).toLocaleString();
                            } else {
                                val = "-";
                            }

                            tableRows += `
                        <tr class="border-bottom-light">
                            <td class="text-secondary ps-3 py-1"><i class="fa-solid ${info.icon} me-1 text-muted" style="font-size: 0.8em; width:15px;"></i>${info.label}</td>
                            <td class="text-end pe-2 py-1 font-monospace text-dark">${val} <span class="text-muted" style="font-size:0.8em;">${info.unit}</span></td>
                        </tr>`;
                        });
                    });

                    // 등급별 색상 적용된 푸터
                    let tableFooter = `
                <tr class="${gradeObj.class} bg-opacity-10 border-top ${gradeObj.border}">
                    <td class="fw-bold ${gradeObj.text} ps-2 py-2"><i class="fa-solid fa-layer-group me-1"></i>최종 등급</td>
                    <td class="text-end fw-bold ${gradeObj.text} pe-2 py-2">${gradeObj.label}</td>
                </tr>`;

                    rightPanel = `
                <div class="border-start bg-white d-flex flex-column" style="width: 340px; max-height: 550px;">
                    <div class="alert alert-primary m-0 rounded-0 border-0 border-bottom fw-bold py-2 px-3 pe-5">
                        <i class="fa-solid fa-droplet me-2"></i>KODV 상세 분석 데이터
                    </div>
                    <div class="overflow-auto flex-grow-1" style="max-height: 500px;">
                        <table class="table table-sm table-borderless small mb-0 w-100">
                            <tbody>${tableRows}${tableFooter}</tbody>
                        </table>
                    </div>
                    <div class="bg-light text-center py-1 border-top text-muted" style="font-size: 0.7rem;">
                        데이터 출처: KODV Knowledge Graph
                    </div>
                </div>`;
                }

                return `<div class="d-flex rounded overflow-hidden shadow">${leftPanel}${rightPanel}</div>`;
            }

        function handleEnter(e) { if(e.key === 'Enter') askAI(); }
        function askAI() {
            var q = $('#searchInput').val(); if(!q) return alert("질문을 입력하세요!");
            showLoading(true, "AI가 분석 중...");
            $('#ai-result-panel').hide();
            if(highlightLayer) map.removeLayer(highlightLayer);
            $.ajax({
                url: '/api/ask', type: 'POST', contentType: 'application/json', data: JSON.stringify({ question: q }),
                success: function(res) {
                    showLoading(false);
                    if(res.status==='success') { lastSparql=res.sparql; displayAIResults(res.data); }
                    else alert("AI 오류: "+res.message);
                },
                error: function(){ showLoading(false); alert("서버 오류"); }
            });
        }

    // [Fix] 검색 결과 표시 함수 (통계 카드 + 동적 지도 로딩 + getProps 통합)
    function displayAIResults(data) {
        var codes = [];

        // 1. 결과 없음 처리
        if (!data || data.length === 0) {
            $('#ai-content').html('<div class="text-center text-muted p-3">결과가 없습니다.</div>');
            $('#ai-result-panel').show();
            // 기존 하이라이트 삭제
            if (window.highlightLayer) map.removeLayer(window.highlightLayer);
            return;
        }

        // 코드 수집 (지도 하이라이트용)
        data.forEach(item => {
            if (item.code) codes.push(item.code.value);
        });

        // ★ [UI 분기] 결과가 1개이고 계산된 값(통계)이라면 -> '통계 카드' 모드
        // (단순 조회인지, 통계 계산인지 구분하기 위해 메타 데이터 키를 제외한 속성이 있는지 확인)
        var keys = Object.keys(data[0]).filter(k => !['name', 'region', 'label', 'code', 'geometry', 'geom'].includes(k));
        var isCalculation = (data.length === 1 && keys.length > 0);

        var html = "";

        if (isCalculation) {
            // [Type B UI] 통계 카드 스타일
            var item = data[0];
            var name = item.name ? item.name.value : "전체 지역";
            var code = item.code ? item.code.value : "";
            
            // 값 추출 (첫 번째 유효한 키 사용)
            var key = keys[0]; 
            var val = item[key].value;
            var mapInfo = ATTR_MAP[key] || { label: '결과값', unit: '', icon: 'fa-calculator', color: 'primary' };

            // 등급 변환 로직
            var displayVal = val;
            var displayLabel = mapInfo.label;
            
            if (key === 'vulnerabilityRatingNumeric') {
                var numVal = Math.round(Number(val));
                var gradeMap = { 1: "I (관심)", 2: "II (주의)", 3: "III (경계)", 4: "IV (심각)", 5: "V (매우심각)" };
                if (gradeMap[numVal]) {
                    displayVal = gradeMap[numVal];
                    mapInfo.unit = "";
                    displayLabel = "평균 등급"; // 라벨 변경
                }
            } else if (!isNaN(val)) {
                if(val.indexOf('.') !== -1) val = parseFloat(val).toFixed(2);
                displayVal = Number(val).toLocaleString();
            }

            html = `
                <div class="p-4 text-center bg-white rounded-3 border shadow-sm">
                    <h5 class="text-secondary fw-bold mb-3"><i class="fa-solid fa-chart-pie me-2"></i>분석 결과</h5>
                    <h3 class="fw-bold text-dark mb-1">${name}</h3>
                    <p class="text-muted small font-monospace mb-4">${code}</p>
                    
                    <div class="d-inline-block bg-${mapInfo.color} bg-opacity-10 rounded-pill px-4 py-2 mb-3">
                        <span class="text-${mapInfo.color} fw-bold">
                            <i class="fa-solid ${mapInfo.icon} me-2"></i>${displayLabel}
                        </span>
                    </div>
                    
                    <h1 class="display-4 fw-bold text-${mapInfo.color} mb-2">${displayVal}<span class="fs-4 ms-2 text-muted">${mapInfo.unit}</span></h1>
                </div>
                <div class="mt-3">
                    <button class="btn btn-sm btn-outline-secondary w-100" onclick="showSparqlModal()">
                        <i class="fa-solid fa-code me-1"></i>생성된 SPARQL 보기
                    </button>
                </div>
            `;

        } else {
            // [Type A/C UI] 기존 리스트 스타일 (여러 개 결과)
            html = '<div class="list-group list-group-flush">';
            data.forEach(function(item) {
                var name = item.name ? item.name.value : (item.region ? item.region.value : "지역명 없음");
                var code = item.code ? item.code.value : "";
                
                var badgesHtml = "";
                Object.keys(item).forEach(function(key) {
                    if (['name', 'region', 'label', 'code', 'geometry', 'geom'].includes(key)) return;
                    
                    var val = item[key].value;
                    var mapInfo = ATTR_MAP[key] || { label: key, unit: '', icon: 'fa-tag', color: 'secondary' };

                    // 등급 변환 로직 (리스트용)
                    if (key === 'vulnerabilityRatingNumeric') {
                        var numVal = Math.round(Number(val));
                        var gradeMap = { 1: "I (관심)", 2: "II (주의)", 3: "III (경계)", 4: "IV (심각)", 5: "V (매우심각)" };
                        if (gradeMap[numVal]) {
                            val = gradeMap[numVal];
                            mapInfo.unit = "";
                            mapInfo.label = "등급";
                        }
                    } else if (!isNaN(val) && val.length > 0) {
                        if(val.indexOf('.') !== -1) val = parseFloat(val).toFixed(2); 
                        val = Number(val).toLocaleString();
                    }

                    badgesHtml += `
                        <span class="badge bg-${mapInfo.color} bg-opacity-10 text-${mapInfo.color} border border-${mapInfo.color} me-1 mb-1">
                            <i class="fa-solid ${mapInfo.icon} me-1"></i>${mapInfo.label}: ${val}${mapInfo.unit}
                        </span>`;
                });

                html += `
                    <a href="#" class="list-group-item list-group-item-action py-3" onclick="moveToRegion('${code}'); return false;">
                        <div class="d-flex w-100 justify-content-between align-items-center mb-1">
                            <h6 class="mb-0 fw-bold text-dark">
                                <i class="fa-solid fa-location-dot text-danger me-2"></i>${name}
                            </h6>
                            <small class="text-muted font-monospace">${code}</small>
                        </div>
                        <div class="mt-1">${badgesHtml}</div>
                    </a>`;
            });
            html += '</div>';
            html += `<div class="p-3 border-top bg-light"><button class="btn btn-sm btn-outline-secondary w-100" onclick="showSparqlModal()"><i class="fa-solid fa-code me-1"></i>생성된 SPARQL 보기</button></div>`;
        }

        $('#ai-content').html(html);
        $('#ai-result-panel').show();

        // 4. 지도 하이라이트 (사용자님 원본 + 동적 로딩 + getProps 통합)
        if (codes.length > 0) {
            if (window.highlightLayer) {
                map.removeLayer(window.highlightLayer);
            }

            // 첫 번째 결과 코드의 길이로 레벨 판단 (모든 결과가 같은 레벨이라고 가정)
            var firstCode = codes[0];
            var targetGeoJson = "";

            // 동적 경로 선택
            if (firstCode.length === 2) {
                targetGeoJson = "/static/sido.json";
            } else if (firstCode.length === 5) {
                targetGeoJson = "/static/sig.json";
            } else {
                targetGeoJson = "/static/emd.geojson";
            }

            $.getJSON(targetGeoJson, function(geoData) {
                var filtered = { type: "FeatureCollection", features: [] };
                
                filtered.features = geoData.features.filter(f => {
                    var props = getProps(f); 
                    return codes.includes(String(props.code));
                });

                if (filtered.features.length > 0) {
                    window.highlightLayer = L.geoJson(filtered, {
                        style: { color: "#dc3545", weight: 3, fillColor: "#dc3545", fillOpacity: 0.4 },
                        onEachFeature: function(feature, layer) {
                            var props = getProps(feature);
                            layer.regionCode = String(props.code);
                            if(props.name) layer.bindTooltip(props.name);
                        }
                    }).addTo(map);
                    
                    var targetBounds = window.highlightLayer.getBounds();
                    var targetCenter = targetBounds.getCenter();

                    // 레벨별 적정 줌 제한 (시도는 멀리, 읍면동은 가까이)
                    var maxZoomLimit = (firstCode.length === 2) ? 8 : (firstCode.length === 5) ? 9 : 11;
                    
                    var targetZoom = map.getBoundsZoom(targetBounds, false, [50, 50]);
                    if (targetZoom > maxZoomLimit) targetZoom = maxZoomLimit;

                    setTimeout(() => {
                        map.flyTo(targetBounds.getCenter(), targetZoom, { duration: 1.5, easeLinearity: 0.25 });
                    }, 100);

                } else {
                    console.error("매칭 실패: " + targetGeoJson + " 에서 코드를 찾지 못했습니다.");
                }
            }).fail(function(){
                console.log("GeoJSON 로드 실패: " + targetGeoJson + " 경로를 확인하세요.");
            });
        }
    }

    // [수정] 리스트 클릭 시 이동 함수 (레벨별 줌 적용)
        function moveToRegion(targetCode) {
            if (!window.highlightLayer) return;

            var foundLayer = null;
            window.highlightLayer.eachLayer(function (layer) {
                if (layer.regionCode === targetCode) {
                    foundLayer = layer;
                }
            });

            if (foundLayer) {
                // 코드 길이에 따라 줌 레벨 동적 결정
                // L1(2자리) -> 8, L2(5자리) -> 9, L3(나머지) -> 11
                var targetZoom = 11;
                if (targetCode.length === 2) targetZoom = 8;
                else if (targetCode.length === 5) targetZoom = 9;

                // flyTo 사용 (부드러운 이동)
                map.flyTo(foundLayer.getBounds().getCenter(), targetZoom, {
                    duration: 1.2,
                    easeLinearity: 0.25
                });

                // 시각적 피드백 (반짝임)
                var originalStyle = { color: "#dc3545", weight: 3, fillColor: "#dc3545", fillOpacity: 0.4 };
                foundLayer.setStyle({ fillOpacity: 0.8, weight: 5, color: "#ff0000" });

                setTimeout(() => {
                    if (window.highlightLayer) foundLayer.setStyle(originalStyle);
                }, 800);
            } else {
                console.log("지도에서 해당 지역을 찾을 수 없습니다.");
            }
        }

        function showSparqlModal() { if(!lastSparql) return; $('#sparql-code').text(lastSparql); new bootstrap.Modal(document.getElementById('sparqlModal')).show(); }
        function showHelpModal() { new bootstrap.Modal(document.getElementById('helpModal')).show(); }
        
        // ★ [신규] 전문가 콘솔 모달
        function showConsoleModal() { new bootstrap.Modal(document.getElementById('consoleModal')).show(); }

        // ★ [신규] 전문가 콘솔 실행
        function runConsoleQuery() {
            var q = $('#console-input').val(); if(!q) return alert("쿼리 입력");
            var btn = $('#consoleModal button i'); btn.attr('class', 'fa-solid fa-spinner fa-spin');
            $.ajax({
                url: '/api/sparql', type: 'POST', contentType: 'application/json', data: JSON.stringify({ query: q }),
                success: function(res) {
                    btn.attr('class', 'fa-solid fa-play');
                    if(res.status==='success') {
                        var h='<tr>'; res.vars.forEach(v=>{h+=`<th>${v}</th>`}); h+='</tr>'; $('#console-result-table thead').html(h);
                        var b=''; 
                        if(res.data.length===0) b=`<tr><td colspan="${res.vars.length}" class="text-center text-muted">결과가 없습니다.</td></tr>`;
                        else {
                            res.data.forEach(r=>{ b+='<tr>'; res.vars.forEach(v=>{ var val=r[v]?r[v].value:""; if(val.startsWith("http")) val=`<a href="${val}" target="_blank">URI</a>`; b+=`<td>${val}</td>`; }); b+='</tr>'; });
                        }
                        $('#console-result-table tbody').html(b);
                    } else alert("Error: "+res.message);
                },
                error: function(){ btn.attr('class', 'fa-solid fa-play'); alert("Conn Error"); }
            });
        }

        window.zoomToRegion = function(lat, lng, level) {
            var z = (level === 'L1') ? 9 : 11;
            map.setView([lat, lng], z, { animate: true, duration: 1.5 });
        };

        function updateLayer() {
            var z = map.getZoom();
            var b = document.getElementById('level-name');
            if(sidoLayer) map.removeLayer(sidoLayer); if(sigLayer) map.removeLayer(sigLayer); if(emdLayer) map.removeLayer(emdLayer); if(highlightLayer) map.addLayer(highlightLayer);
            if(z<9) { if(sidoLayer) map.addLayer(sidoLayer); b.innerText = "광역 (시도)"; }
            else if(z>=9 && z<11) { if(sigLayer) map.addLayer(sigLayer); b.innerText = "기초 (시군구)"; }
            else { if(emdLayer) map.addLayer(emdLayer); b.innerText = "상세 (읍면동)"; }
        }
        map.on('zoomend', updateLayer);

        // [최적화] 페이지 로드 시 TTL 파일 백그라운드 미리 읽기 (Pre-loading)
        document.addEventListener("DOMContentLoaded", function() {
            const ttlContentBox = document.getElementById('ttl-content');
            const loadingText = document.getElementById('ttl-loading');
    
            // 파일 경로 (static 폴더 내 실제 파일명으로 수정 필요)
            const filePath = '/static/KODV_KnowledgeGraph_Final.ttl';

            // 1. 로딩 표시 활성화 (혹시 사용자가 0.1초만에 탭을 누를 경우를 대비)
            if(loadingText) loadingText.style.display = 'inline-block';
            if(ttlContentBox) ttlContentBox.textContent = "Background loading in progress...";

            // 2. 백그라운드 Fetch
            fetch(filePath)
                .then(response => {
                    if (!response.ok) throw new Error("File not found (" + response.status + ")");
                    return response.text();
                })
                .then(text => {
                    // 3. 숨겨진 탭에 미리 텍스트 주입 (DOM 렌더링 비용 미리 지불)
                    if(ttlContentBox) ttlContentBox.textContent = text;
                })
                .catch(err => {
                    if(ttlContentBox) ttlContentBox.textContent = "Error loading TTL: " + err.message;
                })
                .finally(() => {
                    // 4. 로딩 표시 숨김
                    if(loadingText) loadingText.style.display = 'none';
                });
        });

    // ==========================================
    // 4. [신규] 초보자용 쿼리 빌더 (Easy Query Builder)
    // ==========================================
    
    // 모달 열기 및 초기화
    function openEasyQuery() {
        var select = document.getElementById('eq-attribute');
        
        // 속성 목록이 비어있으면 ATTR_MAP 기반으로 채워넣기 (최초 1회)
        if (select.options.length === 0) {
            Object.keys(ATTR_MAP).forEach(key => {
                // val, count 같은 메타 속성은 제외
                if(key === 'val' || key === 'count' || key === 'vulnerabilityRatingNumeric') return;
                
                var info = ATTR_MAP[key];
                var option = document.createElement('option');
                option.value = key;
                option.text = `${info.label} (${info.unit || '수치'})`;
                select.appendChild(option);
            });
        }
        
        new bootstrap.Modal(document.getElementById('easyQueryModal')).show();
        updateEasyPreview(); // 초기 쿼리 생성
    }

    // [수정] 사용자가 입력할 때마다 SPARQL 미리보기 업데이트 (경로 버그 수정됨)
    function updateEasyPreview() {
        var region = document.getElementById('eq-region').value;
        var attrKey = document.getElementById('eq-attribute').value;
        var condition = document.getElementById('eq-condition').value;
        var val = document.getElementById('eq-value').value || 10;
        
        var hintText = document.getElementById('eq-hint');
        
        // 1. 속성 처리
        var propURI = "kodv:" + attrKey;
        var varName = "?" + attrKey;
        
        if (attrKey === 'vulnerabilityRating') {
            propURI = "kodv:vulnerabilityRatingNumeric"; 
            varName = "?vulnerabilityRatingNumeric"; 
        }

        // 2. 쿼리 조립
        var whereClause = `?s a ?type . VALUES ?type { koad:Dong koad:Eup koad:Myeon } .\n  ?s rdfs:label ?name ; koad:divisionCode ?code .\n  ?s ${propURI} ${varName} .`;
        
        // [버그 수정] 지역 필터: L3 -> L2 -> L1까지 올라가는 모든 관계 속성을 포함해야 함
        if (region) {
            // isNeighborhoodOf(동->구), isTownOf(읍->군), isTownshipOf(면->군) 
            // PLUS: isDistrictOf(구->시), isCityOf(시->도), isCountyOf(군->도)
            var path = "koad:isNeighborhoodOf|koad:isTownOf|koad:isTownshipOf|koad:isDistrictOf|koad:isCityOf|koad:isCountyOf";
            
            whereClause += `\n  ?s (${path})+ ?parent .\n  ?parent rdfs:label ?pName .\n  FILTER(CONTAINS(STR(?pName), '${region}'))`;
        }

        // 3. 조건 필터 및 정렬
        var filterSort = "";
        if (condition === 'TOP') {
            filterSort = `ORDER BY DESC(${varName}) LIMIT ${val}`;
            hintText.innerText = `값이 가장 높은 순서대로 상위 ${val}개 지역을 찾습니다.`;
        } else if (condition === 'BOTTOM') {
            filterSort = `ORDER BY ASC(${varName}) LIMIT ${val}`;
            hintText.innerText = `값이 가장 낮은 순서대로 하위 ${val}개 지역을 찾습니다.`;
        } else if (condition === 'GTE') { 
            whereClause += `\n  FILTER(${varName} >= ${val})`;
            filterSort = `ORDER BY DESC(${varName}) LIMIT 50`;
            hintText.innerText = `값이 ${val} 이상인 지역을 찾습니다. (최대 50개)`;
        } else if (condition === 'LTE') { 
            whereClause += `\n  FILTER(${varName} <= ${val})`;
            filterSort = `ORDER BY ASC(${varName}) LIMIT 50`;
            hintText.innerText = `값이 ${val} 이하인 지역을 찾습니다. (최대 50개)`;
        }

        var fullQuery = `SELECT ?name ?code ${varName} WHERE {\n  ${whereClause}\n} ${filterSort}`;
        document.getElementById('eq-preview').innerText = fullQuery;
    }

    // 실행 (기존 전문가용 API 재활용 + 쿼리 보기 연동 수정)
    function runEasyQuery() {
        var query = document.getElementById('eq-preview').innerText;
        var modalEl = document.getElementById('easyQueryModal');
        var modal = bootstrap.Modal.getInstance(modalEl);
        
        modal.hide(); // 모달 닫기
        
        // 검색 결과창 열기 UI
        $('#ai-result-panel').show(); 
        $('#ai-content').html('<div class="text-center p-3"><div class="spinner-border text-success" role="status"></div><div class="mt-2 text-muted">데이터 조회 중...</div></div>');
        
        // 하이라이트 초기화
        if(window.highlightLayer) map.removeLayer(window.highlightLayer);

        // API 호출
        $.ajax({
            url: '/api/sparql',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ query: query }),
            success: function(res) {
                if (res.status === 'success') {
                    // ★ [핵심 수정] 실행한 쿼리를 전역 변수(lastSparql)에 저장해야 버튼이 작동함!
                    lastSparql = query; 
                    
                    // 결과 표시
                    displayAIResults(res.data);
                } else {
                    alert("오류 발생: " + res.message);
                }
            },
            error: function(err) {
                alert("서버 통신 오류");
                console.error(err);
            }
        });
    }
    </script>
</body>
</html>